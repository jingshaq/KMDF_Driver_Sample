/* This file was generated by the Hex-Rays decompiler.
   Copyright (c) 2007-2020 Hex-Rays <info@hex-rays.com>

   Detected compiler: Visual C++
*/

#include <windows.h>
#include <defs.h>

#include <stdarg.h>

DEFINE_GUID (GUID_DEVINTERFACE_AmtPtpDeviceSpiKm,
    0xf271e39d, 0xd211, 0x4a6e, 0xa4, 0x39, 0x63, 0xe5, 0x19, 0x40, 0xd2, 0x10);

//-------------------------------------------------------------------------
// Function declarations

void __fastcall sub_140001000(_QWORD *a1);
_QWORD *__fastcall sub_140001038(_QWORD *a1);
void __fastcall sub_140001058(PLIST_ENTRY ListHead, _LIST_ENTRY *a2, _BYTE *a3);
__int64 __fastcall sub_1400010B4(__int64 a1, unsigned __int16 a2, const void *a3, unsigned int a4, int a5);
void __fastcall sub_140001244(PLIST_ENTRY ListHead);
// PLIST_ENTRY __stdcall RemoveHeadList(PLIST_ENTRY ListHead);
__int64 __fastcall sub_140001294(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5);
__int64 __fastcall sub_140001354(__int64 a1);
__int64 __fastcall sub_14000167C(__int64 a1);
void __fastcall sub_14000183C(__int64 a1, unsigned __int8 a2, __int64 *a3, __int64 a4);
LONGLONG sub_14000186C();
__int64 __fastcall sub_14000189C(unsigned int a1, __int64 a2, __int64 a3, unsigned int a4, void *Dst, size_t Size);
// __int64 DoScreenSave(void); weak
__int64 __fastcall sub_140001CF0(__int64 a1, unsigned int *a2, _BYTE *a3);
__int64 __fastcall sub_140001EBC(__int64 a1, unsigned __int16 a2, __int64 a3, unsigned __int16 a4);
__int64 __fastcall sub_140001F5C(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
__int64 __fastcall sub_140002008(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
__int64 __fastcall sub_1400020B4(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
int __fastcall sub_140002160(__int64 a1, __int64 **a2);
NTSTATUS __fastcall sub_1400023C0(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
NTSTATUS __fastcall sub_140002404(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4);
__int64 __fastcall sub_140002448(__int64 a1);
__int64 __fastcall sub_140002A48(__int64 a1);
void sub_140002C98(char *Format, ...);
__int64 sub_140002DD4(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
__int64 __fastcall sub_140002EC4(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, const char *a6);
__int64 __fastcall sub_140003004(__int64 a1, unsigned int a2, const void *a3, size_t a4);
int __fastcall sub_14000310C(__int64 a1, __int64 a2, unsigned int a3, __int64 a4, int a5);
ULONG __fastcall sub_140003630(__int64 a1, __int64 a2);
__int64 __fastcall sub_140003884(__int64 a1, __int64 a2, __int64 a3, int a4);
__int64 sub_140003A7C(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
__int64 sub_140003B90(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
__int64 __fastcall sub_140003D28(__int64 a1, __int64 a2, __int64 a3);
__int64 __fastcall sub_140003ED0(_QWORD *a1, __int64 a2);
ULONG __fastcall sub_14000419C(__int64 a1);
__int64 __fastcall sub_1400042BC(__int64 a1, int a2);
__int64 __fastcall sub_140004528(__int64 a1, const void *a2, size_t a3);
__int64 __fastcall sub_140004628(__int64 a1);
__int64 __fastcall sub_140004734(__int64 a1);
__int64 __fastcall sub_140004764(__int64 a1, int a2);
__int64 __fastcall sub_1400048E0(__int64 a1);
void __fastcall sub_140004BCC(__int64 a1, unsigned int a2, _BYTE *a3);
bool __fastcall sub_140004CAC(__int64 a1, unsigned int a2);
__int64 __fastcall sub_140004F9C(struct _LIST_ENTRY *a1, _BYTE *a2);
void __fastcall sub_14000502C(__int64 a1, __int64 a2, __int64 a3, __int64 a4);
__int64 __fastcall sub_140005270(__int64 a1, __int64 a2, _BYTE *a3);
__int64 __fastcall sub_1400053D0(__int64 a1);
__int64 __fastcall sub_1400055B8(__int64 a1);
__int64 __fastcall sub_140005690(__int64 a1, unsigned int a2);
__int64 sub_140005808(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...);
__int64 __fastcall sub_14000591C(char a1, char a2, int a3, int a4);
__int64 __fastcall sub_1400059E4(__int16 a1);
// NTSTATUS __stdcall HidP_GetCaps(PHIDP_PREPARSED_DATA PreparsedData, PHIDP_CAPS Capabilities);
// NTSTATUS __stdcall HidP_GetLinkCollectionNodes(PHIDP_LINK_COLLECTION_NODE LinkCollectionNodes, PULONG LinkCollectionNodesLength, PHIDP_PREPARSED_DATA PreparsedData);
// NTSTATUS __stdcall HidP_GetSpecificValueCaps(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, USAGE Usage, PHIDP_VALUE_CAPS ValueCaps, PUSHORT ValueCapsLength, PHIDP_PREPARSED_DATA PreparsedData);
// NTSTATUS __stdcall HidP_GetValueCaps(HIDP_REPORT_TYPE ReportType, PHIDP_VALUE_CAPS ValueCaps, PUSHORT ValueCapsLength, PHIDP_PREPARSED_DATA PreparsedData);
// NTSTATUS __stdcall HidP_GetUsages(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, PUSAGE UsageList, PULONG UsageLength, PHIDP_PREPARSED_DATA PreparsedData, PCHAR Report, ULONG ReportLength);
// NTSTATUS __stdcall HidP_SetUsageValue(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, USAGE Usage, ULONG UsageValue, PHIDP_PREPARSED_DATA PreparsedData, PCHAR Report, ULONG ReportLength);
// NTSTATUS __stdcall HidP_GetUsageValue(HIDP_REPORT_TYPE ReportType, USAGE UsagePage, USHORT LinkCollection, USAGE Usage, PULONG UsageValue, PHIDP_PREPARSED_DATA PreparsedData, PCHAR Report, ULONG ReportLength);
// ULONG DbgPrint(PCSTR Format, ...);
// int __cdecl vsnprintf(char *Dest, size_t Count, const char *Format, va_list Args);
__int64 sub_140005B0C();
NTSTATUS __stdcall DriverEntry(_DRIVER_OBJECT *DriverObject, PUNICODE_STRING RegistryPath);
__int64 __fastcall sub_140005C90(); // weak
__int64 sub_140005C98();
__int64 sub_140005CC0();
__int64 __fastcall sub_140005D2C(__int64 a1);
void *__fastcall sub_140005DC4(__int64 a1);
// __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD); weak
// __int64 __fastcall WppAutoLogStart(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WppAutoLogStop(_QWORD, _QWORD); weak
char __fastcall sub_140005E50(__int64 a1, int a2);
void __fastcall sub_140005E80(__int64 a1, __int64 a2, _BYTE *a3, int a4, void (*a5)(const char *, ...));
void *__fastcall sub_140005EBC(_DWORD *a1, int a2, int a3, __int64 (__fastcall *a4)(const char *));
__int64 __fastcall sub_140005EF0(__int64 a1, int a2);
char __fastcall sub_140005F34(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...));
__int64 __fastcall sub_140005FC4(__int64 a1, int a2);
__int64 __fastcall sub_140005FEC(unsigned int a1, unsigned int *a2);
void *__fastcall sub_140006004(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *, __int64, _QWORD, __int64));
void __fastcall sub_1400060A8(unsigned int *a1, unsigned int *a2, void (*a3)(const char *, ...));
__int64 __fastcall sub_140006130(__int64 a1);
__int64 __fastcall sub_140006150(__int64 a1, __int64 *a2, int a3, int a4, void (__fastcall *a5)(const char *));
__int64 __fastcall sub_1400061A0(__int64 a1, __int64 *a2);
__int64 __fastcall sub_1400061B0(__int64 a1, __int64 *a2);
void __fastcall sub_1400061E0(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...));
__int64 __fastcall sub_14000625C(__int64 a1, _DWORD *a2);
void *__fastcall sub_140006268(_DWORD *a1, __int64 (__fastcall *a2)(const char *));
__int64 __fastcall sub_140006364(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *));
void __fastcall sub_1400063D4(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *));
void *__fastcall sub_140006528(_DWORD *a1, void (__fastcall *a2)(const char *));
__int64 __fastcall sub_140006568(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *));
void __fastcall sub_1400065FC(__int64 a1, __int64 a2, void (*a3)(const char *, ...));
void *__fastcall sub_140006838(_DWORD *a1, void (__fastcall *a2)(const char *));
__int64 __fastcall sub_14000687C(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *));
// __int64 __fastcall WdfVersionBind(_QWORD, _QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WdfVersionUnbind(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WdfVersionBindClass(_QWORD, _QWORD, _QWORD); weak
// __int64 __fastcall WdfVersionUnbindClass(_QWORD, _QWORD, _QWORD); weak
// void *__cdecl memmove(void *Dst, const void *Src, size_t MaxCount);
// void *__cdecl memset(void *Dst, int Val, size_t Size);
// LARGE_INTEGER __stdcall KeQueryPerformanceCounter(PLARGE_INTEGER PerformanceFrequency);
// PVOID __stdcall MmGetSystemRoutineAddress(PUNICODE_STRING SystemRoutineName);
// NTSTATUS __stdcall IoWMIRegistrationControl(PDEVICE_OBJECT DeviceObject, ULONG Action);
// void __stdcall RtlCopyUnicodeString(PUNICODE_STRING DestinationString, PCUNICODE_STRING SourceString);
// void __stdcall RtlInitUnicodeString(PUNICODE_STRING DestinationString, PCWSTR SourceString);
// void __stdcall ExFreePoolWithTag(PVOID P, ULONG Tag);
// PVOID __stdcall ExAllocatePoolWithTag(POOL_TYPE PoolType, SIZE_T NumberOfBytes, ULONG Tag);
// SIZE_T __stdcall RtlCompareMemory(const void *Source1, const void *Source2, SIZE_T Length);
__int64 __fastcall sub_14000D000(__int64 a1);
__int64 __fastcall sub_14000D558(__int64 a1, __int64 a2);
void __fastcall sub_14000D62C(__int64 a1);
void __fastcall sub_14000D6B4(__int64 a1);
void __fastcall sub_14000D740(__int64 a1, __int64 a2);
__int64 (*sub_14000D7E8())(void);
__int64 __fastcall sub_14000D8E0(unsigned __int8 a1, __int64 a2, unsigned int a3, unsigned int *a4, __int64 a5, unsigned int *a6);
__int64 __fastcall sub_14000E000(__int64 a1, __int64 a2);

//-------------------------------------------------------------------------
// Data declarations

_UNKNOWN unk_140009110; // weak
_UNKNOWN unk_140009120; // weak
_UNKNOWN unk_140009130; // weak
_UNKNOWN unk_140009140; // weak
_UNKNOWN unk_140009150; // weak
_UNKNOWN unk_140009160; // weak
_UNKNOWN unk_140009170; // weak
_UNKNOWN unk_140009180; // weak
_UNKNOWN unk_140009190; // weak
_UNKNOWN unk_1400091A0; // weak
_WORD word_1400091B0[24] = //SHORT UnitExponent_Table[24]=
{
  5,
  5,
  6,
  6,
  7,
  7,
  8,
  -8,
  9,
  -7,
  10,
  -6,
  11,
  -5,
  12,
  -4,
  13,
  -3,
  14,
  -2,
  15,
  -1,
  0,
  0
}; // idb
_DWORD dword_1400091E0[6] = { 0, 1, 2, 3, 4, 0 }; // idb//LONG Unit_TABLE[6]
void *off_14000A018 = &unk_14000A000; // weak
PDEVICE_OBJECT DeviceObject = &DeviceObject; // idb
_UNKNOWN unk_14000A040; // weak
_UNKNOWN unk_14000A070; // weak
_QWORD qword_14000A080 = 0i64; // idb
void *off_14000A088 = &unk_14000A070; // weak
_UNKNOWN unk_14000A090; // weak
_UNKNOWN unk_14000A0A0; // weak
__int64 (__fastcall *qword_14000A0C0)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
__int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
__int64 (*qword_14000A0D0)(void) = NULL; // weak
__int64 (__fastcall *qword_14000A0D8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
__int64 (__fastcall *qword_14000A0E0)(_QWORD, _QWORD, _QWORD, _QWORD) = NULL; // weak
int dword_14000A0E8 = 0; // weak
struct _UNICODE_STRING DestinationString = { 0u, 0u, NULL }; // idb
__int64 (*qword_14000A108)(void) = NULL; // weak
__int64 qword_14000A110 = 0i64; // weak
__int64 qword_14000A118 = 0i64; // weak
__int64 qword_14000A120 = 0i64; // weak
__int64 qword_14000A128 = 0i64; // weak
_UNKNOWN unk_14000A130; // weak
struct _DEVICE_OBJECT stru_14000A340; // idb


//----- (0000000140001000) ----------------------------------------------------
void __fastcall sub_140001000(_QWORD *a1)  //FreePool_PLIST_ENTRY(PLIST_ENTRY_a1)
{
  void *v2; // rcx

  v2 = (void *)a1[3];//PLIST_ENTRY_a1[3]
  if ( v2 )
  {
    ExFreePoolWithTag(v2, 0x50747046u);
    a1[3] = 0i64;
  }
  ExFreePoolWithTag(a1, 0x50747046u);
}

//----- (0000000140001038) ----------------------------------------------------
_QWORD *__fastcall sub_140001038(_QWORD *a1)  //pDeviceContext_a1
{//可能是Nextdevice、AttachedDevice、DeviceExtension、DEVICE_OBJECT、PhysicalDeviceObject成员的操作
  _QWORD *result; // rax

  a1[117] = a1 + 116;  //pDeviceContext_a1-> DeviceExtension =pDeviceContext_a1->DeviceObject??
  a1[116] = a1 + 116; 
  result = a1 + 118;  //pDeviceContext_a1->AttachedTo??
  a1[119] = a1 + 118;  //pDeviceContext_a1->NextDeviceObject =pDeviceContext_a1->AttachedTo;??
  a1[118] = a1 + 118;  //pDeviceContext_a1->NextDeviceObject =pDeviceContext_a1 ->Nextdevice??
  return result;
}

//----- (0000000140001058) ----------------------------------------------------
void __fastcall sub_140001058(PLIST_ENTRY ListHead, _LIST_ENTRY *a2, _BYTE *a3)
{
  PLIST_ENTRY v6; // rax
  _LIST_ENTRY *v7; // rcx

  for ( ; ListHead->Flink != ListHead; a2->Blink = v6 )
  {
    v6 = RemoveHeadList(ListHead);
    v7 = a2->Blink;
    v6->Flink = a2;
    v6->Blink = v7;
    if ( v7->Flink != a2 )
      __fastfail(3u);
    v7->Flink = v6;
  }
  *a3 = 1;
}

//----- (00000001400010B4) ----------------------------------------------------
__int64 __fastcall sub_1400010B4(__int64 a1, unsigned __int16 a2, const void *a3, unsigned int a4, int a5)
//NTSTATUS PTPFilterBufferStoreReport(LIST_ENTRY_a1, REPORT_BUFFER_SIZE_a2 ,PCHAR ReportBuffer_a3, ReportLength_a4, CurrentFingersCountValue_a5)
{
  size_t v6; // rbp
  unsigned int v9; // esi
  PVOID v10; // rbx
  PVOID v11; // rax
  _QWORD *v12; // rax

  v6 = a4;//ReportLength_v6 =ReportLength_a4;
  v9 = 0;//status_v9 = STATUS_SUCCESS;
  v10 = ExAllocatePoolWithTag(NonPagedPool, 0x20ui64, 0x50747046u);//PVOID_Buffer STRUCT_TOUCHPAD_PACKET=ExAllocatePoolWithTag(NonPagedPool, 0x20ui64, 0x50747046u);//30 length手指数据长度
  if ( v10 )//STRUCT_TOUCHPAD_PACKET
  {
    v11 = ExAllocatePoolWithTag(NonPagedPool, a2, 0x50747046u);//PVOID STRUCT_TOUCHPAD_FINGER =ExAllocatePoolWithTag(NonPagedPool, REPORT_BUFFER_SIZE_a2, 0x50747046u);
    *((_QWORD *)v10 + 3) = v11;//STRUCT_TOUCHPAD_PACKET->         = STRUCT_TOUCHPAD_FINGER;
    if ( v11 )
    {
      memset(v11, 0, a2);//REPORT_BUFFER_SIZE_a2
      if ( a2 >= (unsigned int)v6 )
        memmove(*((void **)v10 + 3), a3, v6);  // STRUCT_TOUCHPAD_PACKET->                ,ReportBuffer_a3, ReportLength_v6
      *((_DWORD *)v10 + 4) = a5;  //STRUCT_TOUCHPAD_PACKET->      CurrentFingersCountValue_a5;
      v12 = *(_QWORD **)(a1 + 8); // //v12=   LIST_ENTRY_a1->     ;
      *(_QWORD *)v10 = a1;    //STRUCT_TOUCHPAD_PACKET =LIST_ENTRY_a1;
      *((_QWORD *)v10 + 1) = v12;//STRUCT_TOUCHPAD_PACKET->v12;
      if ( *v12 != a1 )  //v12 !=LIST_ENTRY_a1
        __fastfail(3u);//__fastfail(FAST_FAIL_STACK_COOKIE_CHECK_FAILURE);//RtlFailFast(_In_ ULONG Code)
      *v12 = v10; //v12 =STRUCT_TOUCHPAD_PACKET ;
      *(_QWORD *)(a1 + 8) = v10;  //LIST_ENTRY_a1->          = STRUCT_TOUCHPAD_PACKET;
    }
    else
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 1u, 0xBu, (__int64)&unk_140009120);
      DbgPrint("[PTP] %s : ", "PTPFilterBufferStoreReport");
      DbgPrint("ExAllocatePoolWithTag for input report failed");
      DbgPrint("\n");
      v9 = -1073741664;//STATUS_MEMORY_NOT_ALLOCATED      ((NTSTATUS)0xC00000A0L)
      ExFreePoolWithTag(v10, 0x50747046u);///0x50747046u=MOUHID_TAG
    }
  }
  else
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 1u, 0xAu, (__int64)&unk_140009120);
    DbgPrint("[PTP] %s : ", "PTPFilterBufferStoreReport");
    DbgPrint("ExAllocatePoolWithTag for list entry failed");
    DbgPrint("\n");
    v9 = -1073741664;//STATUS_MEMORY_NOT_ALLOCATED      ((NTSTATUS)0xC00000A0L)
  }
  return v9;//status_v9
}

//----- (0000000140001244) ----------------------------------------------------
void __fastcall sub_140001244(PLIST_ENTRY ListHead)//Delete_PLIST_ENTRY(ListHead);
{
  PLIST_ENTRY v2; // rax

  while ( ListHead->Flink != ListHead )
  {
    v2 = RemoveHeadList(ListHead);
    sub_140001000(v2);//FreePool_PLIST_ENTRY(PLIST_ENTRY_v2)
  }
}

//----- (0000000140001294) ----------------------------------------------------
__int64 __fastcall sub_140001294(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5)//
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-28h]

  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, 0i64);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, 0i64);
}
// 140001335: variable 'v12' is possibly undefined
// 140005E3C: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140001354) ----------------------------------------------------
__int64 __fastcall sub_140001354(__int64 a1)//PTPFilterDevicePrepareHardware(Device_a1);
{
  __int64 v1; // rbx
  _QWORD *v2; // r14
  _QWORD *v3; // rsi
  int v4; // eax
  unsigned int v5; // edi
  int v6; // eax
  __int64 v7; // rcx
  int v8; // eax
  __int64 v10; // [rsp+28h] [rbp-58h]
  _QWORD Dst[8]; // [rsp+40h] [rbp-40h] BYREF

  v1 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
         qword_14000A110,
         a1,
         off_14000A018);//pDeviceContext_v1 = GetDeviceContext(Device_a1);
  v2 = (_QWORD *)(v1 + 768);//ReuseRequest_v2=pDeviceContext_v1->ReuseRequest_v768;
  *(_BYTE *)v1 = 0; //pDeviceContext_v1=NULL；
  v3 = (_QWORD *)(v1 + 776);//RequestBuffer_v3=pDeviceContext_v1->RequestBuffer__776;
  *(_QWORD *)(v1 + 768) = 0i64;//pDeviceContext_v1->ReuseRequest_v768=NULL;
  *(_QWORD *)(v1 + 776) = 0i64;//pDeviceContext_v1->RequestBuffer__776=NULL;
  *(_DWORD *)(v1 + 4) = 0;
  v4 = sub_140002448(v1);//status_v4=Hid_StartDevice(pDeviceContext_a1);
  v5 = v4;
  if ( v4 < 0 )
  {
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x13u, (__int64)&unk_140009140, v4);
    DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
    DbgPrint("PtpFilterGetDeviceProperties failed %!STATUS!", v5);
LABEL_3:
    DbgPrint("\n");
    goto LABEL_10;
  }
  sub_140006004(
    v1 + 64,
    *(_QWORD *)(v1 + 880),//pDeviceContext_v1->Physical_Length_X
    (void (__fastcall *)(const char *, __int64, _QWORD, __int64))sub_140002C98);//
  
//下面3行实际是WDF_OBJECT_ATTRIBUTES_INIT(&RequestAttributes_Dst)执行的联合效果;
  memset(Dst, 0, 0x38ui64);
  LODWORD(Dst[0]) = 56;
  Dst[3] = 0x100000001i64;
  
  Dst[4] = *(_QWORD *)(v1 + 8);//RequestAttributes_Dst.ParentObject=pDeviceContext_v1->hDevice;
  
  v6 = (*(__int64 (__fastcall **)(__int64, _QWORD *, _QWORD, _QWORD *))(qword_14000A118 + 1976))(
         qword_14000A110,//status_v6 = WdfRequestCreate(
         Dst,//&RequestAttributes_Dst
         0i64,//IoTarget=NULL;
         v2);//&ReuseRequest_v2
         
  v5 = v6;
  if ( v6 >= 0 )
  {
  	  ////下面3行实际是WDF_OBJECT_ATTRIBUTES_INIT(&RequestAttributes_Dst)执行的联合效果;
    memset(Dst, 0, 0x38ui64);
    LODWORD(Dst[0]) = 56;
    Dst[3] = 0x100000001i64;
    
    Dst[4] = *(_QWORD *)(v1 + 8);////RequestAttributes_Dst.ParentObject=pDeviceContext_v1->hDevice;
    
    v7 = *(unsigned __int16 *)(v1 + 812);//REPORT_BUFFER_SIZE_v7= pDeviceContext_v1->REPORT_BUFFER_SIZE_812;
    *(_DWORD *)(v1 + 792) = v7;//pDeviceContext_a1->ReportLength_792=v7;
    if ( !(_WORD)v7 )
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x15u, (__int64)&unk_140009140);
      DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
      DbgPrint("InputReportByteLength is 0");
      goto LABEL_3;
    }
    v8 = (*(__int64 (__fastcall **)(__int64, _QWORD *, _QWORD, __int64, __int64, _QWORD *, __int64))(qword_14000A118 + 1536))(
           qword_14000A110,//status_v8= WdfMemoryCreate( 
           Dst,//RequestAttributes_Dst
           0i64,//NonPagedPool  //POOL_TYPE PoolType,
           1349808198i64,  //ULONG PoolTag, //0x50747046
           v7, //REPORT_BUFFER_SIZE_v7
           v3, //RequestBuffer_v3
           v1 + 784);//pDeviceContext_v1->PCHAR ReportBuffer_784
           
    v5 = v8;
    if ( v8 >= 0 )
      return v5;
    
    LODWORD(v10) = v8;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x16u, (__int64)&unk_140009140, v10);
    DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
    DbgPrint("WdfMemoryCreate failed %!STATUS!", v5);
    DbgPrint("\n");
    *v3 = 0i64;
  }
  else
  {
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x14u, (__int64)&unk_140009140, v6);
    DbgPrint("[PTP] %s : ", "PTPFilterDevicePrepareHardware");
    DbgPrint("WdfRequestCreate failed %!STATUS!", v5);
    DbgPrint("\n");
    *v2 = 0i64; //ReuseRequest_v2 =NULL；
  }
LABEL_10:
  if ( (v5 & 0x80000000) != 0 )
  {
    if ( *v2 )
    {
      (*(void (__fastcall **)(__int64))(qword_14000A118 + 1664))(qword_14000A110);//
      *v2 = 0i64; ////ReuseRequest_v2 =NULL；
    }
    if ( *v3 )
    {
      (*(void (__fastcall **)(__int64))(qword_14000A118 + 1664))(qword_14000A110);
      *v3 = 0i64; //RequestBuffer_v3=NULL；
      *(_QWORD *)(v1 + 784) = 0i64;//pDeviceContext_v1->PCHAR ReportBuffer_784=NULL;
    }
  }
  return v5;
}
// 1400015DB: variable 'v10' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000167C) ----------------------------------------------------
__int64 __fastcall sub_14000167C(__int64 a1)//PTPFilterDeviceReleaseHardware(Device_a1)
{
  __int64 v2; // rbx
  void *v3; // rcx
  void *v4; // rcx

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 2u, 0x17u, (__int64)&unk_140009140);
    DbgPrint("[PTP] %s : ", "PTPFilterDeviceReleaseHardware");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v2 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
         qword_14000A110,
         a1,
         off_14000A018);//pDeviceContext_v2 = GetDeviceContext(Device_a1);
  *(_BYTE *)(v2 + 920) = 1;//pDeviceContext_v2->RequestLength=1;
  sub_140001244((PLIST_ENTRY)(v2 + 928));//Delete_PLIST_ENTRY(pDeviceContext_v2->LIST_ENTRY_928);
  sub_140001244((PLIST_ENTRY)(v2 + 944));//Delete_PLIST_ENTRY(pDeviceContext_v2->LIST_ENTRY_944);
  if ( *(_QWORD *)(v2 + 768) )  //（ pDeviceContext_v2->ReuseRequest_v768)
  {
    (*(void (__fastcall **)(__int64))(qword_14000A118 + 2064))(qword_14000A110);
    (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 1664))(qword_14000A110, *(_QWORD *)(v2 + 768));//WdfObjectDelete(pDeviceContext_v2->ReuseRequest_v768); 
    *(_QWORD *)(v2 + 768) = 0i64;//pDeviceContext_v2->ReuseRequest_v768= NULL;
  }
  if ( *(_QWORD *)(v2 + 776) )//pDeviceContext_v2->RequestBuffer__776
  {
    (*(void (__fastcall **)(__int64))(qword_14000A118 + 1664))(qword_14000A110);//WdfObjectDelete(pDeviceContext_v2->RequestBuffer__776); ???少个参数及少一行代码？？
    *(_QWORD *)(v2 + 776) = 0i64;//pDeviceContext_v2->RequestBuffer__776=NULL;
    *(_QWORD *)(v2 + 784) = 0i64;//pDeviceContext_v2->PCHAR ReportBuffer_784=NULL;
  }
  v3 = *(void **)(v2 + 800); //v3 =pDeviceContext_v2->PreparsedData_800;
  if ( v3 )
  {
    ExFreePoolWithTag(v3, 0x50747046u);////0x50747046u=MOUHID_TAG
    *(_QWORD *)(v2 + 800) = 0i64;//pDeviceContext_v2->PreparsedData_800=NULL;
  }
  v4 = *(void **)(v2 + 872);//pDeviceContext_v2->UsageListBuffer_872
  if ( v4 )
  {
    ExFreePoolWithTag(v4, 0x50747046u);///0x50747046u=MOUHID_TAG
    *(_QWORD *)(v2 + 872) = 0i64;//pDeviceContext_v2->UsageListBuffer_872=NULL;
  }
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 2u, 0x18u, (__int64)&unk_140009140);
    DbgPrint("[PTP] %s : ", "PTPFilterDeviceReleaseHardware");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
  return 0i64;
}
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000183C) ----------------------------------------------------
void __fastcall sub_14000183C(__int64 a1, unsigned __int8 a2, __int64 *a3, __int64 a4)
{
  __int64 v4; // rax

  if ( a2 <= 1u )
  {
    v4 = 0i64;
    if ( a2 )
    {
      *(_DWORD *)(a4 + 44) = *((_DWORD *)a3 + 1);
      *(_BYTE *)(a4 + 41) = *((_BYTE *)a3 + 2);
      v4 = *a3;
    }
    else
    {
      *(_BYTE *)(a4 + 41) = 0;
      *(_DWORD *)(a4 + 44) = 0;
    }
    *(_QWORD *)(a4 + 24) = v4;
  }
}

//----- (000000014000186C) ----------------------------------------------------
LONGLONG sub_14000186C()
{
  __int128 v1; // rtt
  union _LARGE_INTEGER PerformanceFrequency; // [rsp+30h] [rbp+8h] BYREF

  PerformanceFrequency.QuadPart = 0i64;
  v1 = 1000i64 * *(_QWORD *)&KeQueryPerformanceCounter(&PerformanceFrequency);
  return v1 / PerformanceFrequency.QuadPart;
}

//----- (000000014000189C) ----------------------------------------------------
__int64 __fastcall sub_14000189C(unsigned int a1, __int64 a2, __int64 a3, unsigned int a4, void *Dst, size_t Size)
//NTSTATUS  ptpfilter_WdfIoTargetFormatRequestForInternalIoctl(IoControlCode_a1, IoTarget_a2,  InputBuffer_a3, InputBuffer_size_a4,OutputBuffer_Dst,OutputBuffer_size);
{
  __int64 *v6; // rax
  __int64 *v7; // rsi
  __int64 v11; // [rsp+40h] [rbp-29h] BYREF
  __int64 v12; // [rsp+48h] [rbp-21h]
  __int64 v13; // [rsp+50h] [rbp-19h]
  __int64 v14; // [rsp+58h] [rbp-11h] BYREF
  void *v15; // [rsp+60h] [rbp-9h]
  __int64 v16; // [rsp+68h] [rbp-1h]
  __int64 v17[2]; // [rsp+70h] [rbp+7h] BYREF

  LODWORD(v11) = 0;  //
  v6 = 0i64;  //
  LODWORD(v14) = 0;
  v7 = 0i64;
  v12 = 0i64;
  v13 = 0i64;
  v15 = 0i64;
  v16 = 0i64;
  if ( a3 )  //if(InputBuffer_a3)
  {
    v12 = a3;  //InputBuffer_v12=InputBuffer_a3;
    v7 = &v11;  //
    v11 = 1i64;  
    v13 = a4;   //InputBuffer_size_v13= InputBuffer_size_a4;
  }
  if ( Dst )  //if(OutputBuffer_Dst)
  {
    memset(Dst, 0, (unsigned int)Size);  //memset(OutputBuffer_Dst,0,OutputBuffer_size);
    v15 = Dst;  //OutputBuffer_v15 =OutputBuffer_Dst;
    v6 = &v14;  //
    v14 = 1i64;   //bool_v14=TRUE;
    v16 = (unsigned int)Size;  //OutputBuffer_size_v16 =OutputBuffer_size;
  }
  v17[1] = -10000000i64;
  v17[0] = 0x300000010i64;
  return (*(__int64 (__fastcall **)(__int64, __int64, _QWORD, _QWORD, __int64 *, __int64 *, __int64 *, _QWORD, __int64, __int64, __int64, __int64, void *, __int64))(qword_14000A118 + 1488))(
           qword_14000A110,// return WdfIoTargetFormatRequestForInternalIoctl(   ??
           a2,     //IoTarget_a2
           0i64,  //
           a1,  //IoControlCode_a1
           v7,  
           v6,  
           v17,  //
           0i64,  
           v11, //bool_v11=InputBuffer_a3?TRUE:FALSE;
           v12,  //InputBuffer_v12
           v13,  //InputBuffer_size_v13
           v14,  //bool_v14=OutputBuffer_Dst?TRUE:FALSE;
           v15, //OutputBuffer_v15
           v16);//OutputBuffer_size_v16
  
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140001CF0) ----------------------------------------------------
__int64 __fastcall sub_140001CF0(__int64 a1, unsigned int *a2, _BYTE *a3)//PTPFilterGetFingersCount (pDeviceContext_a1, *CurrentFingersCountValue__a2 ,boolFlag_FingerNotChanged_a3)
{
  NTSTATUS v6; // eax
  unsigned int v7; // edi
  int v8; // eax
  unsigned int v9; // ecx
  __int64 v11; // [rsp+28h] [rbp-20h]
  ULONG v12; // [rsp+50h] [rbp+8h] BYREF

  *a3 = 0;  //boolFlag_FingerNotChanged_a3 =FALSE;
  v6 = HidP_GetUsageValue(
         HidP_Input,
         0xDu,//HID_USAGE_PAGE_DIGITIZER
         0,//HIDP_LINK_COLLECTION_UNSPECIFIED
         0x54u,//USAGE ID (Contact count)  =54 //Contact Count	Total number of contacts to be reported in a given report.
         &v12,//&CurrentFingersCountValue_v12
         *(PHIDP_PREPARSED_DATA *)(a1 + 800),//pDeviceContext_a1->PreparsedData_800,
         *(PCHAR *)(a1 + 784),////pDeviceContext_a1->PCHAR ReportBuffer_784,
         *(_DWORD *)(a1 + 792));//pDeviceContext_a1->ReportLength_792,
  v7 = v6;//status_v7=status_v6;
  if ( v6 < 0 )
  {
    LODWORD(v11) = v6;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x1Au, (__int64)&unk_140009160, v11);
    DbgPrint("[PTP] %s : ", "PTPFilterGetFingersCount");
    DbgPrint("Could not obtain actual count from OEM HID report - %!STATUS!", v7);
    DbgPrint("\n");
    return v7;
  }
  v8 = *(_DWORD *)(a1 + 900);//LastFingerCount_v8=pDeviceContext_a1->LastFingerCount_900;??
  if ( v8 )
  {
    if ( v12 )//CurrentFingersCountValue_v12
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x1Bu, (__int64)&unk_140009160);
      DbgPrint("[PTP] %s : ", "PTPFilterGetFingersCount");
      DbgPrint("Expected report with 0 actual count in OEM HID report");
LABEL_6:
      DbgPrint("\n");
      return (unsigned int)-1073739509;////return STATUS_BAD_DATA                  ((NTSTATUS)0xC000090BL)
    }
  }
  else
  {
    if ( !v12 )//CurrentFingersCountValue_v12
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x1Cu, (__int64)&unk_140009160);
      DbgPrint("[PTP] %s : ", "PTPFilterGetFingersCount");
      DbgPrint("Non-zero actual count expected in OEM HID report");
      goto LABEL_6;
    }
    *(_DWORD *)(a1 + 904) = v12;//pDeviceContext_a1->CurrentFingerCount_904=CurrentFingersCountValue_v12;
  }
  v9 = *(_DWORD *)(a1 + 904) - v8;//FingerChangeCount_v9 = pDeviceContext_a1->CurrentFingerCount_904- LastFingerCount_v8 ;
  if ( *(_DWORD *)(a1 + 896) < v9 )//if(pDeviceContext_a1->MaxFingerCount_896 <FingerChangeCount_v9 )??
    v9 = *(_DWORD *)(a1 + 896);  //FingerChangeCount_v9 =pDeviceContext_a1->MaxFingerCount_896 ;??
  *a2 = v9;  //CurrentFingersCountValue__a2 = FingerChangeCount_v9;??
  *(_DWORD *)(a1 + 900) += v9;  //pDeviceContext_a1->LastFingerCount_900 += FingerChangeCount_v9 ;??
  if ( *(_DWORD *)(a1 + 900) == *(_DWORD *)(a1 + 904) )  //if ( pDeviceContext_a1->LastFingerCount_900 == pDeviceContext_a1->CurrentFingerCount_904 ) ??
    *a3 = 1;  //boolFlag_FingerNotChanged_a3 =TRUE;
  return v7;
}
// 140001E23: conditional instruction was optimized away because of 'eax.4!=0'
// 140001E6D: conditional instruction was optimized away because of 'eax.4==0'
// 140001D7B: variable 'v11' is possibly undefined

//----- (0000000140001EBC) ----------------------------------------------------
__int64 __fastcall sub_140001EBC(__int64 a1, unsigned __int16 a2, __int64 a3, unsigned __int16 a4)
{
  unsigned __int16 v4; // r10
  unsigned __int16 i; // r11
  unsigned __int16 v8; // dx
  __int64 result; // rax
  __int64 v10; // rcx
  __int128 v11; // xmm2
  __int128 v12; // xmm3

  v4 = 0;
  for ( i = 0; i < a4; ++i )
  {
    v8 = v4;
    if ( v4 < a2 )
    {
      while ( 1 )
      {
        result = 32i64 * v8;
        if ( *(_WORD *)(32i64 * i + a3 + 24) == *(_WORD *)(result + a1 + 24) )
          break;
        if ( ++v8 >= a2 )
          goto LABEL_9;
      }
      if ( v8 != v4 )
      {
        v10 = 32i64 * v4;
        result = 32i64 * v8;
        v11 = *(_OWORD *)(v10 + a1);
        v12 = *(_OWORD *)(v10 + a1 + 16);
        *(_OWORD *)(v10 + a1) = *(_OWORD *)(result + a1);
        *(_OWORD *)(v10 + a1 + 16) = *(_OWORD *)(result + a1 + 16);
        *(_OWORD *)(result + a1) = v11;
        *(_OWORD *)(result + a1 + 16) = v12;
      }
      ++v4;
    }
LABEL_9:
    ;
  }
  return result;
}

//----- (0000000140001F5C) ----------------------------------------------------
__int64 __fastcall sub_140001F5C(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
	//PTPFilterReadContactId(PULONG UsageValue, USHORT HIDP_LINK_COLLECTION_a2, CHAR *Report, pDeviceContext_a4)
{
  NTSTATUS v4; // eax
  unsigned int v5; // ebx
  PHIDP_PREPARSED_DATA PreparsedData; // [rsp+28h] [rbp-20h]

  *UsageValue = 0;
  v4 = HidP_GetUsageValue(
         HidP_Input,
         0xDu,//HID_USAGE_PAGE_DIGITIZER
         a2,//HIDP_LINK_COLLECTION_a2
         0x51u,//USAGE ID(Contact Identifier) //触摸点ID号
         UsageValue,//返回值Contact Identifier
         *(PHIDP_PREPARSED_DATA *)(a4 + 800),//pDeviceContext_a4->PreparsedData_800,
         Report,
         *(_DWORD *)(a4 + 792));//pDeviceContext_a4->ReportLength_792
  v5 = v4;
  if ( v4 < 0 )
  {
    LODWORD(PreparsedData) = v4;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x1Eu, (__int64)&unk_140009160, PreparsedData);
    DbgPrint("[PTP] %s : ", "PTPFilterReadContactId");
    DbgPrint("HidP_GetUsageValue for HID_USAGE_CONTACTID failed with status - %!STATUS!", v5);
    DbgPrint("\n");
  }
  return v5;
}
// 140001FCE: variable 'PreparsedData' is possibly undefined

//----- (0000000140002008) ----------------------------------------------------
__int64 __fastcall sub_140002008(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)//未被调用？？？
//PTPFilterReadContactTX(PULONG UsageValue, USHORT HIDP_LINK_COLLECTION_a2, CHAR *Report, pDeviceContext_a4)
{
  NTSTATUS v4; // eax
  unsigned int v5; // ebx
  PHIDP_PREPARSED_DATA PreparsedData; // [rsp+28h] [rbp-20h]

  *UsageValue = 0;
  v4 = HidP_GetUsageValue(
         HidP_Input,
         1u,//HID_USAGE_PAGE_GENERIC
         a2,//HIDP_LINK_COLLECTION_a2
         0x30u,//HID_USAGE_GENERIC_X  //USAGE(X)       X移动
         UsageValue,////获得X移动返回值
         *(PHIDP_PREPARSED_DATA *)(a4 + 800),//pDeviceContext_a4->PreparsedData_800,
         Report,
         *(_DWORD *)(a4 + 792));//pDeviceContext_a4->ReportLength_792
  v5 = v4;
  if ( v4 < 0 )
  {
    LODWORD(PreparsedData) = v4;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x1Fu, (__int64)&unk_140009160, PreparsedData);
    DbgPrint("[PTP] %s : ", "PTPFilterReadContactTX");
    DbgPrint("HidP_GetUsageValue for HID_USAGE_GENERIC_X failed with status - %!STATUS!", v5);
    DbgPrint("\n");
  }
  return v5;
}
// 14000207A: variable 'PreparsedData' is possibly undefined

//----- (00000001400020B4) ----------------------------------------------------
__int64 __fastcall sub_1400020B4(PULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
//PTPFilterReadContactTY(PULONG UsageValue, USHORT HIDP_LINK_COLLECTION_a2, CHAR *Report, pDeviceContext_a4)
{
  NTSTATUS v4; // eax
  unsigned int v5; // ebx
  PHIDP_PREPARSED_DATA PreparsedData; // [rsp+28h] [rbp-20h]

  *UsageValue = 0;
  v4 = HidP_GetUsageValue(
         HidP_Input,
         1u,//HID_USAGE_PAGE_GENERIC
         a2,//HIDP_LINK_COLLECTION_a2
         0x31u,//HID_USAGE_GENERIC_Y  //USAGE(Y)       Y移动
         UsageValue,//获得Y移动返回值
         *(PHIDP_PREPARSED_DATA *)(a4 + 800),//pDeviceContext_a4->PreparsedData_800,
         Report,
         *(_DWORD *)(a4 + 792));//pDeviceContext_a4->ReportLength_792
  v5 = v4;
  if ( v4 < 0 )
  {
    LODWORD(PreparsedData) = v4;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x20u, (__int64)&unk_140009160, PreparsedData);
    DbgPrint("[PTP] %s : ", "PTPFilterReadContactTY");
    DbgPrint("HidP_GetUsageValue for HID_USAGE_GENERIC_Y failed with status - %!STATUS!", v5);
    DbgPrint("\n");
  }
  return v5;
}
// 140002126: variable 'PreparsedData' is possibly undefined

//----- (0000000140002160) ----------------------------------------------------
int __fastcall sub_140002160(__int64 a1, __int64 **a2)//PTPFilterRewritePosition(pDeviceContext_a1, *PLIST_ENTRY_a2)
{
  __int64 *v2; // rbx
  _OWORD *v3; // rax
  char *v4; // r8
  int v7; // er9
  __int64 v8; // rcx
  __int128 v9; // xmm1
  __int128 v10; // xmm0
  __int128 v11; // xmm1
  __int128 v12; // xmm0
  __int128 v13; // xmm1
  __int128 v14; // xmm0
  __int128 v15; // xmm1
  __int128 v16; // xmm1
  __int128 v17; // xmm0
  __int128 v18; // xmm1
  __int128 v19; // xmm0
  __int128 v20; // xmm1
  CHAR *v21; // r15
  USHORT v22; // di
  int result; // eax
  unsigned __int16 i; // dx
  __int64 v25; // r12
  ULONG UsageValue[4]; // [rsp+30h] [rbp-228h] BYREF
  char v27; // [rsp+40h] [rbp-218h] BYREF
  int v28; // [rsp+48h] [rbp-210h]
  _OWORD v29[29]; // [rsp+50h] [rbp-208h]//128位数，__m128i

  v2 = *a2;
  v3 = (_OWORD *)(a1 + 88);
  v4 = &v27;
  v7 = 0;
  v8 = 3i64;
  do
  {
    v9 = v3[1];
    *(_OWORD *)v4 = *v3;
    v10 = v3[2];
    *((_OWORD *)v4 + 1) = v9;
    v11 = v3[3];
    *((_OWORD *)v4 + 2) = v10;
    v12 = v3[4];
    *((_OWORD *)v4 + 3) = v11;
    v13 = v3[5];
    *((_OWORD *)v4 + 4) = v12;
    v14 = v3[6];
    *((_OWORD *)v4 + 5) = v13;
    v15 = v3[7];
    v3 += 8;
    *((_OWORD *)v4 + 6) = v14;
    v4 += 128;
    *((_OWORD *)v4 - 1) = v15;
    --v8;
  }
  while ( v8 );
  v16 = v3[1];
  *(_OWORD *)v4 = *v3;
  v17 = v3[2];
  *((_OWORD *)v4 + 1) = v16;
  v18 = v3[3];
  *((_OWORD *)v4 + 2) = v17;
  v19 = v3[4];
  *((_OWORD *)v4 + 3) = v18;
  v20 = v3[5];
  *((_OWORD *)v4 + 4) = v19;
  *((_OWORD *)v4 + 5) = v20;
  if ( v2 == (__int64 *)a2 )
    return v7;
  while ( 1 )
  {
    v21 = (CHAR *)v2[3];
    if ( *((_DWORD *)v2 + 4) )
      break;
LABEL_14:
    v2 = (__int64 *)*v2;
    if ( v2 == (__int64 *)a2 )
      return v7;
  }
  v22 = 1;
  while ( 1 )
  {
    result = sub_140001F5C(UsageValue, v22, v21, a1);//NTSTATUS_result =PTPFilterReadContactId(PULONG UsageValue, USHORT HIDP_LINK_COLLECTION_v22,  CHAR *Report_v21, pDeviceContext_a1);
    if ( result < 0 )
      return result;
    for ( i = 0; i < v28; ++i )
    {
      if ( LOWORD(v29[3 * i]) == UsageValue[0] )
        break;
    }
    if ( i == v28 )
    {
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x26u, (__int64)&unk_140009160, UsageValue[0]);
      DbgPrint("[PTP] %s : ", "PTPFilterRewritePosition");
      DbgPrint("Finger with contactId %d not found in Fingers", UsageValue[0]);
      DbgPrint("\n");
      return -1073741811;// STATUS_INVALID_PARAMETER         ((NTSTATUS)0xC000000DL)
    }
    v25 = 3i64 * i;
    result = sub_1400023C0(DWORD2(v29[3 * i + 2]) / *(_DWORD *)(a1 + 888), v22, v21, a1);//UsageValue=PhysicalX_value/TouchPad_Physical_DotDistance_X逻辑坐标x=物理坐标x/点距
    ////NTSTATUS_result = PTPFilterSetUsageValuePosX(ULONG UsageValue, USHORT HIDP_LINK_COLLECTION_v22, CHAR *Report_v21, pDeviceContext_a1)
    if ( result != 1114112 )//HIDP_STATUS_SUCCESS
      return result;
    result = sub_140002404(HIDWORD(v29[v25 + 2]) / *(_DWORD *)(a1 + 892), v22, v21, a1);//UsageValue=PhysicalY_value/TouchPad_Physical_DotDistance_Y逻辑坐标y=物理坐标y/点距
    //NTSTATUS_result = PTPFilterSetUsageValuePosY(ULONG UsageValue, USHORT HIDP_LINK_COLLECTION_v22, CHAR *Report_v21, pDeviceContext_a1)
    v7 = result;
    if ( result != 1114112 )//HIDP_STATUS_SUCCESS
      return result;
    if ( (unsigned int)v22++ >= *((_DWORD *)v2 + 4) )
      goto LABEL_14;
  }
}

//----- (00000001400023C0) ----------------------------------------------------
NTSTATUS __fastcall sub_1400023C0(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
	////PTPFilterSetUsageValuePosX(ULONG UsageValue, USHORT HIDP_LINK_COLLECTION_a2, CHAR *Report, pDeviceContext_a4)
{
  return HidP_SetUsageValue(
           HidP_Input,
           1u,
           a2,//HIDP_LINK_COLLECTION_a2
           0x30u,//
           UsageValue,
           *(PHIDP_PREPARSED_DATA *)(a4 + 800),//pDeviceContext_a4->PreparsedData_800,
           Report,
           *(_DWORD *)(a4 + 792));//pDeviceContext_a4->ReportLength_792
}

//----- (0000000140002404) ----------------------------------------------------
NTSTATUS __fastcall sub_140002404(ULONG UsageValue, USHORT a2, CHAR *Report, __int64 a4)
	//PTPFilterSetUsageValuePosY(ULONG UsageValue, USHORT HIDP_LINK_COLLECTION_a2, CHAR *Report, pDeviceContext_a4)
{
  return HidP_SetUsageValue(
           HidP_Input,
           1u,
           a2,//HIDP_LINK_COLLECTION_a2
           0x31u,
           UsageValue,
           *(PHIDP_PREPARSED_DATA *)(a4 + 800),//pDeviceContext_a4->PreparsedData_800,
           Report,
           *(_DWORD *)(a4 + 792));//pDeviceContext_a4->ReportLength_792
}

//----- (0000000140002448) ----------------------------------------------------
__int64 __fastcall sub_140002448(__int64 a1)//Hid_StartDevice(pDeviceContext_a1)
{
  unsigned __int16 v2; // bp
  __int64 v3; // rdx
  char v4; // r12
  char v5; // r13
  int v6; // ebx
  unsigned __int16 v7; // r9
  PVOID Dst; // rax
  NTSTATUS v9; // eax
  unsigned __int16 v10; // ax
  PVOID v11; // rax
  int v12; // eax
  _WORD *v13; // r15
  unsigned __int16 v14; // ax
  struct _HIDP_VALUE_CAPS *v15; // rax
  struct _HIDP_VALUE_CAPS *v16; // rsi
  NTSTATUS v17; // eax
  int v18; // eax
  int v19; // eax
  void *v20; // rcx
  void *v21; // rcx
  size_t Size; // [rsp+28h] [rbp-50h]
  size_t Sizea; // [rsp+28h] [rbp-50h]
  SIZE_T NumberOfBytes; // [rsp+30h] [rbp-48h] BYREF
  int v26; // [rsp+38h] [rbp-40h]

  v2 = 0;
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0xEu, (__int64)&unk_140009160);
    DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v3 = *(_QWORD *)(a1 + 16);//IoTarget_v3=pDeviceContext_v3->IoTarget;
  NumberOfBytes = 0i64;//HID_COLLECTION_INFORMATION_NumberOfBytes=NULL;
  v26 = 0;
  LODWORD(Size) = 12;//Size=sizeof(HID_COLLECTION_INFORMATION);
  v4 = 0; //bGetCaps_x_ok=FALSE;
  v5 = 0;//bGetCaps_y_ok=FALSE;
  v6 = sub_14000189C(0xB01A8u, v3, 0i64, 0, &NumberOfBytes, Size);
  ////设置IOCTL请求status_6 = ptpfilter_WdfIoTargetFormatRequestForInternalIoctl(IOCTL_HID_GET_COLLECTION_INFORMATION, IoTarget_v3,  InputBuffer_NULL, InputBuffer_size,&OutputBuffer_HID_COLLECTION_INFORMATION_NumberOfBytes,OutputBuffer_size);
    if ( v6 < 0 )
  if ( v6 < 0 )
  {
    v7 = 15;
LABEL_5:
    LODWORD(Sizea) = v6;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, v7, (__int64)&unk_140009160, Sizea);//
    DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
    DbgPrint("PTPFilterCallHidClassSynchronously failed %!STATUS!", (unsigned int)v6);
LABEL_6:
    DbgPrint("\n");
    goto LABEL_39;
  }
  Dst = ExAllocatePoolWithTag(NonPagedPool, (unsigned int)NumberOfBytes, 0x50747046u);//0x50747046u=MOUHID_TAG
  *(_QWORD *)(a1 + 800) = Dst;//pDeviceContext_a1->PreparsedData_800=Dst;
  if ( Dst )
  {
    LODWORD(Sizea) = NumberOfBytes;//Sizea=NumberOfBytes->DescriptorSize;
    v6 = sub_14000189C(0xB0193u, *(_QWORD *)(a1 + 16), 0i64, 0, Dst, Sizea);  //pDeviceContext_a1->IoTarget ,
    //设置IOCTL请求status_6 = ptpfilter_WdfIoTargetFormatRequestForInternalIoctl(IOCTL_HID_GET_COLLECTION_DESCRIPTOR, IoTarget,  InputBuffer_NULL, InputBuffer_size,OutputBuffer_Dst,OutputBuffer_size);
    if ( v6 < 0 )
    {
      v7 = 17;
      goto LABEL_5;
    }
    v9 = HidP_GetCaps(*(PHIDP_PREPARSED_DATA *)(a1 + 800), (PHIDP_CAPS)(a1 + 808));//Status_v9 = HidP_GetCaps(pDeviceContext_a1->PreparsedData_800, &pDeviceContext_a1->Capabilities_808);
    v6 = v9;
    if ( v9 < 0 )
    {
      LODWORD(Sizea) = v9;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x12u, (__int64)&unk_140009160, Sizea);
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("HidP_GetCaps failed %!STATUS!", (unsigned int)v6);
      goto LABEL_6;
    }
    v10 = *(_WORD *)(a1 + 854);//PULONG UsageLength_v10=pDeviceContext_a1->UsageLength_854
    if ( !v10 )
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x13u, (__int64)&unk_140009160);
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("NumberInputButtonCaps is 0");
      goto LABEL_6;
    }
    v11 = ExAllocatePoolWithTag(NonPagedPool, 2i64 * v10, 0x50747046u);//PVOID_Buffer_v11=ExAllocatePoolWithTag(NonPagedPool, 2* sizeof(USAGE) * UsageLength_v10, MOUHID_TAG);
    *(_QWORD *)(a1 + 872) = v11;//pDeviceContext_a1->UsageListBuffer_872 = PVOID_Buffer_v11;
    if ( v11 )
    {
      v12 = sub_140002A48(a1);//NTSTATUS _v12=PtpFilterGetMaxFingers(pDeviceContext_a1)//获取MaxFingers的函数
      v6 = v12;
      if ( v12 < 0 )
      {
        LODWORD(Sizea) = v12;
        sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x15u, (__int64)&unk_140009160, Sizea);
        DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
        DbgPrint("PtpFilterGetMaxFingers failed %!STATUS!", (unsigned int)v6);
        goto LABEL_6;
      }
      v13 = (_WORD *)(a1 + 856);//pValueCapsLength_v13=pDeviceContext_a1->ValueCapsLength_856;
      v14 = *(_WORD *)(a1 + 856);//ULONG ValueCapsLength_v14=pDeviceContext_a1->ValueCapsLength_856;
      if ( !v14 )
      {
        sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x16u, (__int64)&unk_140009160);
        DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
        DbgPrint("NumberInputValueCaps is 0");
        goto LABEL_6;
      }
      v15 = (struct _HIDP_VALUE_CAPS *)ExAllocatePoolWithTag(NonPagedPool, 72i64 * v14, 0x50747046u);//ValueCaps_buffer_v15=ExAllocatePoolWithTag(NonPagedPool, 72* ValueCapsLength_v14, MOUHID_TAG);
      v16 = v15;//ValueCaps_buffer_v16[0]=ValueCaps_buffer_v15;
      if ( v15 )
      {
        v17 = HidP_GetValueCaps(HidP_Input, v15, (PUSHORT)(a1 + 856), *(PHIDP_PREPARSED_DATA *)(a1 + 800));
        ////status_v17=HidP_GetValueCaps (HidP_Input,&ValueCaps_buffer_v15,pDeviceContext_a1->ValueCapsLength_856,pDeviceContext_a1-> PreparsedData_800);
        v6 = v17;//status_v6=status_v17;
        if ( v17 >= 0 )
        {
          if ( *v13 )
          {
            do //搜索匹配的ValueCaps
            {
              if ( !v4 && v16[v2].Range.UsageMin == 48 && v16[v2].UsagePage == 1 )//if(!bGetCaps_x_ok && ValueCaps_buffer_v16[v2].Range.UsageMin==HID_USAGE_GENERIC_X && ValueCaps_buffer_v16.UsagePage == HID_USAGE_PAGE_GENERIC
              {
                v18 = sub_14000591C(v16[v2].UnitsExp, v16[v2].Units, v16[v2].PhysicalMax, v16[v2].PhysicalMin);//GetPhysicalValue(v16[v2].UnitsExp, v16[v2].Units, v16[v2].PhysicalMax, v16[v2].PhysicalMin);
                //Physical_Length_X=
                *(_DWORD *)(a1 + 880) = v18;//=Physical_Length_X
                v4 = 1;
                *(_DWORD *)(a1 + 888) = v18 / (v16[v2].LogicalMax - v16[v2].LogicalMin);//TouchPad_Physical_DotDistance_X=
              }
              if ( !v5 && v16[v2].Range.UsageMin == 49 && v16[v2].UsagePage == 1 )////if(!bGetCaps_y_ok && ValueCaps_buffer_v16[v2].Range.UsageMin==HID_USAGE_GENERIC_Y && ValueCaps_buffer_v16.UsagePage == HID_USAGE_PAGE_GENERIC
              {
                v19 = sub_14000591C(v16[v2].UnitsExp, v16[v2].Units, v16[v2].PhysicalMax, v16[v2].PhysicalMin);
                *(_DWORD *)(a1 + 884) = v19;//pDeviceContext_a1->Physical_Length_Y
                v5 = 1;
                *(_DWORD *)(a1 + 892) = v19 / (v16[v2].LogicalMax - v16[v2].LogicalMin);//TouchPad_Physical_DotDistance_Y=
              }
              if ( v4 && v5 )//if( bGetCaps_x_ok &&  bGetCaps_x_ok)
                break;
              ++v2;//
            }
            while ( v2 != *v13 );//v2!=DeviceObject->ValueCapsLength_856
          }
        }
        else
        {
          LODWORD(Sizea) = v17;
          sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x18u, (__int64)&unk_140009160, Sizea);
          DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
          DbgPrint("HidP_GetValueCaps failed %!STATUS!", (unsigned int)v6);
          DbgPrint("\n");
        }
        ExFreePoolWithTag(v16, 0x50747046u);///0x50747046u=MOUHID_TAG
LABEL_39:
        if ( v6 >= 0 )
          goto LABEL_44;
        goto LABEL_40;
      }
      sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x17u, (__int64)&unk_140009160);
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("ExAllocatePoolWithTag for value caps failed");
    }
    else
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x14u, (__int64)&unk_140009160);
      DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
      DbgPrint("ExAllocatePoolWithTag for button usages failed");
    }
    DbgPrint("\n");
    v6 = -1073741801;//status_v6=STATUS_NO_MEMORY                 ((NTSTATUS)0xC0000017L) 
  }
  else
  {
    v6 = -1073741670;//status_v6=STATUS_INSUFFICIENT_RESOURCES    ((NTSTATUS)0xC000009AL)
    LODWORD(Sizea) = -1073741670;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0x10u, (__int64)&unk_140009160, Sizea);//
    DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
    DbgPrint("ExAllocatePoolWithTag for preparsed data failed %!STATUS!", 3221225626i64);
    DbgPrint("\n");
  }
LABEL_40:
  v20 = *(void **)(a1 + 872);//PVOID buffer_v20=DeviceObject_a1->UsageListBuffer_872;
  if ( v20 )
  {
    ExFreePoolWithTag(v20, 0x50747046u);
    *(_QWORD *)(a1 + 872) = 0i64;//DeviceObject_a1->UsageListBuffer_872=NULL;
  }
  v21 = *(void **)(a1 + 800);////PVOID_HIDP_PREPARSED_DATA_v21=DeviceObject->PreparsedData_800,
  if ( v21 )
  {
    ExFreePoolWithTag(v21, 0x50747046u);
    *(_QWORD *)(a1 + 800) = 0i64;////pDeviceContext_a1->PreparsedData_800=NULL,
  }
LABEL_44:
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0x19u, (__int64)&unk_140009160);
    DbgPrint("[PTP] %s : ", "PtpFilterGetDeviceProperties");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
  return (unsigned int)v6;
}
// 140002508: variable 'Size' is possibly undefined
// 140002532: variable 'Sizea' is possibly undefined

//----- (0000000140002A48) ----------------------------------------------------
__int64 __fastcall sub_140002A48(__int64 a1)//NTSTATUS PtpFilterGetMaxFingers(pDeviceContext_a1 ) 
{
  struct _HIDP_PREPARSED_DATA *v2; // r8
  unsigned int v3; // ebx
  NTSTATUS v4; // eax
  USHORT v5; // si
  USHORT ValueCapsLength[2]; // [rsp+40h] [rbp-88h] BYREF
  ULONG LinkCollectionNodesLength[3]; // [rsp+44h] [rbp-84h] BYREF
  struct _HIDP_VALUE_CAPS ValueCaps; // [rsp+50h] [rbp-78h] BYREF

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0xAu, (__int64)&unk_140009160);
    DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v2 = *(struct _HIDP_PREPARSED_DATA **)(a1 + 800);//_HIDP_PREPARSED_DATA_v2=pDeviceContext_a1-> PreparsedData;
  *(_DWORD *)(a1 + 896) = 0;//pDeviceContext_a1->MaxFingerCount_896
  if ( v2 )
  {
    LinkCollectionNodesLength[0] = 0;
    v4 = HidP_GetLinkCollectionNodes(0i64, LinkCollectionNodesLength, v2);//_HIDP_PREPARSED_DATA_v2
    v3 = v4;
    if ( v4 == -1072627705 )//status_v4==0xc0110007
    {
      v5 = 1;//HIDP_LINK_COLLECTION_v5 =1;
      ValueCapsLength[0] = 1;
      if ( LinkCollectionNodesLength[0] > 1 )
      {
        do
        {
          v3 = HidP_GetSpecificValueCaps(//status_v3
                 HidP_Input,
                 0xDu,//HID_USAGE_PAGE_DIGITIZER
                 v5,//HIDP_LINK_COLLECTION_v5
                 0x51u,////USAGE ID(Contact Identifier) //触摸点ID号
                 &ValueCaps,
                 ValueCapsLength,
                 *(PHIDP_PREPARSED_DATA *)(a1 + 800));////pDeviceContext_a1->PreparsedData_800,
          if ( v3 == 1114112 )//status_v3==HIDP_STATUS_SUCCESS
            ++*(_DWORD *)(a1 + 896);//pDeviceContext_a1->MaxFingerCount_896
          ++v5;
        }
        while ( v5 < LinkCollectionNodesLength[0] );//HIDP_LINK_COLLECTION_v5<
      }
      if ( !*(_DWORD *)(a1 + 896) )//pDeviceContext_a1->MaxFingerCount_896
        v3 = -1073739509;//status_v3 = STATUS_BAD_DATA                  ((NTSTATUS)0xC000090BL)
    }
    else
    {
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0xCu, (__int64)&unk_140009160, v4);
      DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
      DbgPrint("HidP_GetLinkCollectionNodes failed %!STATUS!", v3);
      DbgPrint("\n");
    }
  }
  else
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 4u, 0xBu, (__int64)&unk_140009160);
    DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
    DbgPrint("HIDPreparsedData is NULL");
    DbgPrint("\n");
    v3 = -1073741811;//status_v3 = STATUS_INVALID_PARAMETER         ((NTSTATUS)0xC000000DL)
  }
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 4u, 0xDu, (__int64)&unk_140009160);
    DbgPrint("[PTP] %s : ", "PtpFilterGetMaxFingers");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
  return v3;
}

//----- (0000000140002C98) ----------------------------------------------------
void sub_140002C98(char *Format, ...)
{
  int v1; // eax
  char Dest[511]; // [rsp+30h] [rbp-218h] BYREF
  char v3; // [rsp+22Fh] [rbp-19h]
  va_list va; // [rsp+258h] [rbp+10h] BYREF

  va_start(va, Format);
  if ( Format )
  {
    v1 = vsnprintf(Dest, 0x1FFui64, Format, va);
    if ( v1 < 0 || (unsigned __int64)v1 > 0x1FF )
    {
      v3 = 0;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 4u, 0xAu, 0xAu, (__int64)&unk_140009170, -2147483643);
      DbgPrint("[PTP] %s : ", "Logger");
      DbgPrint("RtlStringCbVPrintfA failed %x", 2147483653i64);
    }
    else
    {
      if ( v1 == 511i64 )//==0x1FF
        v3 = 0;
      sub_140002EC4((__int64)DeviceObject->DeviceExtension, 4u, 0xAu, 0xBu, (__int64)&unk_140009170, Dest);
      DbgPrint("[PTP] %s : ", "Logger");
      DbgPrint("%s", Dest);
    }
    DbgPrint("\n");
  }
}

//----- (0000000140002DD4) ----------------------------------------------------
__int64 sub_140002DD4(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
 //NTSTATUS WppTraceCallback( _In_ UCHAR MinorFunction, _In_opt_ PVOID DataPath, _In_ ULONG BufferLength,  _Inout_updates_bytes_(BufferLength) PVOID Buffer, _Out_ PULONG Size);
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-38h]
  va_list va; // [rsp+88h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 140002EA4: variable 'v12' is possibly undefined
// 140005E3C: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140002EC4) ----------------------------------------------------
__int64 __fastcall sub_140002EC4(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, const char *a6)
{
  const char *v6; // rbp
  unsigned __int64 v10; // rsi
  __int64 v11; // rbx
  int v12; // eax
  __int64 v13; // rcx
  const char *v14; // rax
  int v16; // [rsp+20h] [rbp-48h]
  __int64 v17; // [rsp+70h] [rbp+8h]

  v17 = a1;
  v6 = "NULL";
  v10 = (unsigned __int64)a3 >> 16;
  v11 = -1i64;
  v12 = *((_DWORD *)&DeviceObject->Timer + 20 * v10 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v12, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v10 + 1) >= a2 )
  {
    if ( a6 )
    {
      v13 = -1i64;
      do
        ++v13;
      while ( a6[v13] );
    }
    v14 = "NULL";
    if ( a6 )
      v14 = a6;
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v10), 43i64, a5, a4, v14);
    a1 = v17;
  }
  if ( a6 )
  {
    do
      ++v11;
    while ( a6[v11] );
  }
  if ( a6 )
    v6 = a6;
  LOWORD(v16) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v16, v6);
}
// 140002FE0: variable 'v16' is possibly undefined
// 140005E3C: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140003004) ----------------------------------------------------
__int64 __fastcall sub_140003004(__int64 a1, unsigned int a2, const void *a3, size_t a4)//ptpfilterCompleteRequestWithData(Request_a1, NTSTATUS_code_a2, sourceBuffer_a3 , size_a4);//&IoControlCode_a3 =sourceBuffer_a3可转变为缓冲地址？？
{
  int v8; // eax
  unsigned int v9; // ebx
  int v11; // [rsp+28h] [rbp-20h]
  void *Dst; // [rsp+30h] [rbp-18h] BYREF
  size_t Size[2]; // [rsp+38h] [rbp-10h] BYREF

  v8 = (*(__int64 (__fastcall **)(__int64, __int64, size_t, void **, size_t *))(qword_14000A118 + 2160))(
         qword_14000A110, //v8= WdfRequestRetrieveOutputBuffer(Request, MinimumRequiredLength, PVOID* outBuffer,size_t* Length);
         a1,  //Request_a1
         a4,  //size_a4
         &Dst, //Buffer_DSt;
         Size); //Size
  v9 = v8;
  if ( v8 >= 0 )
  {
    memset(Dst, 0, Size[0]);
    memmove(Dst, a3, a4);//DSt,sourceBuffer_a3, size_a4
    (*(void (__fastcall **)(__int64, __int64, _QWORD, size_t))(qword_14000A118 + 2120))(qword_14000A110, a1, a2, a4);
    //void WdfRequestCompleteWithInformation(Request_a1, NTSTATUS_code_a2, ULONG_PTR Information_size_a4)
  }
  else
  {
    v11 = v8;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0xAu, (__int64)&unk_140009180, v11);
    DbgPrint("[PTP] %s : ", "CompleteRequestWithData");
    DbgPrint("CompleteRequestWithData failed with status - %!STATUS!", v9);
    DbgPrint("\n");
  }
  return v9;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000310C) ----------------------------------------------------
int __fastcall sub_14000310C(__int64 a1, __int64 a2, unsigned int a3, __int64 a4, int a5)
//void PTPFilterEvtIoDeviceControl(IN WDFQUEUE Queue_a1, IN WDFREQUEST Request_a2,  IN size_t  OutputBufferLength_a3, IN size_t InputBufferLength_a4, IN ULONG IoControlCode_a5 )
{
  int v9; // ebx
  __int64 v10; // rax
  __int64 v11; // rax
  __int64 v12; // rdi
  int v13; // ebx
  int v14; // ebx
  int v15; // ebx
  int result; // eax
  int v17; // ebx
  unsigned __int32 v18; // er14
  __int32 v19; // ecx
  char v20; // al
  unsigned __int32 v21; // ebx
  __int64 v22; // [rsp+20h] [rbp-60h]
  __int64 v23; // [rsp+28h] [rbp-58h]
  __int64 v24; // [rsp+28h] [rbp-58h]
  __int64 v25; // [rsp+50h] [rbp-30h] BYREF
  __m128i *v26; // [rsp+58h] [rbp-28h] BYREF
  __m128i v27; // [rsp+60h] [rbp-20h]

  v9 = a5;//IoControlCode_v9=IoControlCode_a5;
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140003B90((__int64)DeviceObject->DeviceExtension, 5u, 5u, 0xEu, (__int64)&unk_140009180, a1, a2, a3, a4, a5);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
    LODWORD(v24) = v9;  //  =IoControlCode_v9；
    LODWORD(v22) = a4;  //InputBufferLength_a4
    DbgPrint(
      "%!FUNC! Entry : Queue 0x%p, Request 0x%p OutputBufferLength %d InputBufferLength %d IoControlCode %d",
      a1,
      a2,
      a3,
      v22,
      v24);
    DbgPrint("\n");
  }
  v10 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 1256))(qword_14000A110, a1);//WDFDEVICE Device_v10 = WdfIoQueueGetDevice(Queue_a1);
  v11 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
          qword_14000A110,
          v10,
          off_14000A018);//DeviceContext* DeviceContext_v11 = GetDeviceContext(Device_v10);
  v12 = v11;//pDeviceContext_v12=DeviceContext_v11;
  v13 = v9 - 737216;//IoControlCode_v13 = IoControlCode_v9 -737216     //测试v13 = IOCTL_HID_GET_DEVICE_DESCRIPTOR - 16317=0x000ac046;/404582
  if ( !v13 )////HID_CTL_CODE(17)
  {
    if ( (*(int (__fastcall **)(__int64, __int64, __int64, __m128i **, __int64 *))(qword_14000A118 + 2152))(//
           qword_14000A110,//WdfRequestRetrieveInputBuffer( _In_WDFREQUEST Request_a2,_In_size_t MinimumRequiredLength, _Outptr_result_bytebuffer_(*Length)PVOID* Buffer,_Out_opt_size_t* Length);
           a2,  //Request_a2
           a4,  //InputBufferLength_a4
           &v26,  //_Outptr_result_bytebuffer_(*Length)PVOID* Buffer
           &v25  //_Out_opt_size_t* Length
           	   ) >= 0
      && v25 == 20 )//Length_v25==20
    {
      v19 = v26[1].m128i_i32[0];
      v20 = _mm_cvtsi128_si32(*v26);
      v27 = *v26;
      *(_BYTE *)v12 = v20;
      if ( v20 )
      {
        *(_QWORD *)(v12 + 80) = *(__int64 *)((char *)v27.m128i_i64 + 4);
        *(_DWORD *)(v12 + 88) = v27.m128i_i32[3] * v27.m128i_i32[3];
        *(_DWORD *)(v12 + 92) = v19 * v19;
      }
      v21 = v27.m128i_i32[0];
      LODWORD(v23) = v27.m128i_i32[0];
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x10u, (__int64)&unk_140009180, v23);
      DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
      DbgPrint("START_STOP_FILTERING PARAMS, state: %d", v21);
      DbgPrint("\n");
    }
    LOWORD(a5) = *(_WORD *)(v12 + 880);//=pDeviceContext_v12->Physical_Length_X
    HIWORD(a5) = *(_WORD *)(v12 + 884);//=pDeviceContext_v12->Physical_Length_Y
    result = sub_140003004(a2, 0, &a5, 4ui64);//result = ptpfilterCompleteRequestWithData(Request_a2, STATUS_SUCCESS，&IoControlCode_a5 , 4);//&IoControlCode_a5=sourceBuffer_a5可转变为缓冲地址？
    goto LABEL_24;
  }
  v14 = v13 - 4;
  if ( !v14 )//HID_CTL_CODE(16)
  {
    LODWORD(v23) = 737220;//
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x11u, (__int64)&unk_140009180, v23);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
    DbgPrint("PTPFilterEvtIoDeviceControl FLUSH %d", 737220i64);
    DbgPrint("\n");
    *(_DWORD *)(v12 + 4) = 2;
    result = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD, _QWORD))(qword_14000A118 + 2120))(
               qword_14000A110,//void WdfRequestCompleteWithInformation(Request_a2, NTSTATUS_code, ULONG_PTR Information_size)
               a2,  //Request_a2
               0i64,
               0i64);
    goto LABEL_15;
  }
  v15 = v14 - 4;HID_CTL_CODE(15)
  if ( v15 )
  {
    if ( v15 == 52 )
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 0, 5u, 0xFu, (__int64)&unk_140009180);
      DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
      DbgPrint("OUTPUT3: IOCTL_PTPFILTER_GET_FEATURE_REPORT");
      DbgPrint("\n");
      result = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2248))(
                 qword_14000A110,//status_result = WdfRequestForwardToIoQueue(
                 a2,  //Request_a2
                 *(_QWORD *)(v12 + 32));//pDeviceContext_v12->ReportQueue_32
    }
    else
    {
      result = sub_140003884(a2, v11, 0i64, 8);//result = PTPFilterSendControlRequest(Request_a2, DeviceContext_v11,  NULL, _In_opt_PWDF_REQUEST_SEND_OPTIONS 0x8);
    }
LABEL_24:
    v17 = result;
    goto LABEL_25;
  }
  sub_140001294((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x12u, (__int64)&unk_140009180);
  DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
  DbgPrint("OUTPUT3: IOCTL_PTPFILTER_SWITCH_MODE");
  DbgPrint("\n");
  v17 = (*(__int64 (__fastcall **)(__int64, __int64, __int64, __m128i **, __int64 *))(qword_14000A118 + 2152))(
          qword_14000A110,//v17 = WdfRequestRetrieveInputBuffer( _In_WDFREQUEST Request_a2,_In_size_t MinimumRequiredLength, _Outptr_result_bytebuffer_(*Length)PVOID* Buffer,_Out_opt_size_t* Length);
          a2,  //Request_a2
          a4,  //InputBufferLength_a4
          &v26,  //_Outptr_result_bytebuffer_(*Length)PVOID* Buffer
          &v25);//Out_opt_size_t* Length_v25
  if ( v17 >= 0 )
  {
    if ( v25 == 4 )  //Length_v25==4
    {
      v18 = v26->m128i_i32[0];
      if ( *(_BYTE *)v12 )//pDeviceContext_v12
      {
        *(_DWORD *)(v12 + 584) = v18;//pDeviceContext_v12->
        LODWORD(v23) = v18;
        sub_140002DD4((__int64)DeviceObject->DeviceExtension, 0, 5u, 0x13u, (__int64)&unk_140009180, v23);
        DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
        DbgPrint("OUTPUT3: IOCTL_PTPFILTER_SWITCH_MODE - %d", v18);
        DbgPrint("\n");
      }
    }
    result = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD, _QWORD))(qword_14000A118 + 2120))(
               qword_14000A110,//void WdfRequestCompleteWithInformation(Request_a2, NTSTATUS_code, ULONG_PTR Information_size)
               a2,  //Request_a2
               (unsigned int)v17,
               0i64);
LABEL_25:
    if ( v17 >= 0 )
      goto LABEL_15;
  }
  LODWORD(v23) = v17;
  sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0x14u, (__int64)&unk_140009180, v23);
  DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
  DbgPrint("PTPFilterEvtIoDeviceControl failed %!STATUS!", (unsigned int)v17);
  DbgPrint("\n");
  result = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD, _QWORD))(qword_14000A118 + 2120))(
             qword_14000A110,//void WdfRequestCompleteWithInformation(Request_a2, NTSTATUS_code, ULONG_PTR Information_size)
             a2,  //Request_a2
             (unsigned int)v17,
             0i64);
LABEL_15:
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 5u, 0x15u, (__int64)&unk_140009180);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoDeviceControl");
    DbgPrint("%!FUNC! Exit");
    result = DbgPrint("\n");
  }
  return result;
}
// 1400031B2: variable 'v22' is possibly undefined
// 1400031B2: variable 'v24' is possibly undefined
// 140003371: variable 'v23' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140003630) ----------------------------------------------------
ULONG __fastcall sub_140003630(__int64 a1, __int64 a2)//PTPFilterEvtIoRead(_In_ WDFQUEUE Queue_a1, _In_ WDFREQUEST Request_a2, _In_size_t Length)
{
  __int64 v4; // rax
  __int64 v5; // rsi
  int v6; // eax
  unsigned int v7; // ebx
  int v8; // eax
  ULONG result; // eax
  __int64 v10; // [rsp+28h] [rbp-20h]
  char v11; // [rsp+68h] [rbp+20h] BYREF

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140003A7C((__int64)DeviceObject->DeviceExtension, 5u, 5u, 0x16u, (__int64)&unk_140009180, a1, a2);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
    DbgPrint("%!FUNC! Entry : Queue 0x%p, Request 0x%p", a1, a2);//
    DbgPrint("\n");
  }
  v4 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 1256))(qword_14000A110, a1);//WDFDEVICE Device_v4 = WdfIoQueueGetDevice(Queue_a1);
  v5 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
         qword_14000A110,
         v4,
         off_14000A018);//pDeviceContext_v5 = GetDeviceContext(Device_v4);
  v11 = 0;//bRequestForwardFlag=FALSE;
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2528))(qword_14000A110, *(_QWORD *)(v5 + 912));//WdfSpinLockAcquire (pDeviceContext_v5->ReadLoopSpinLock_912);
  v6 = sub_140003D28(v5, a2, (__int64)sub_14000502C); //设置I/O 请求完成回调例程
//status_v6=PTPFilterCheckAndStartReadLoop(pDeviceContext_v5,Request_a2,Filter_EvtRequestIoctlCompletionRoutine_sub_14000502C);
  v7 = v6;//status_v7=status_v6;
  if ( v6 >= 0 )
  {
    v8 = sub_140005270(v5, a2, &v11);//status_v8=PTPFilterProcessCurrentRequest(pDeviceContext_v5,Request_a2,&bRequestForwardFlag);
    v7 = v8;//status_v7=status_v8;
    if ( v8 >= 0 )
      goto LABEL_8;
    LODWORD(v10) = v8;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0x18u, (__int64)&unk_140009180, v10);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
    DbgPrint("PTPFilterProcessCurrentRequest failed %!STATUS!", v7);
  }
  else
  {
    LODWORD(v10) = v6;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0x17u, (__int64)&unk_140009180, v10);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
    DbgPrint("PTPFilterCheckAndStartReadLoop failed %!STATUS!", v7);
  }
  DbgPrint("\n");
LABEL_8:
  result = (*(__int64 (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(v5 + 912));////status_result=(NTSTATUS *) void WdfSpinLockRelease (pDeviceContext_v5->ReadLoopSpinLock_912);
  if ( !v11 )  //if(bRequestForwardFlag==FALSE)
    result = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2104))(qword_14000A110, a2, v7);//status_result= (NTSTATUS *) void WdfRequestComplete(Request_a2, status_v7);???
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 5u, 0x19u, (__int64)&unk_140009180);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtIoRead");
    DbgPrint("%!FUNC! Exit");
    result = DbgPrint("\n");
  }
  return result;
}
// 140003749: variable 'v10' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140003884) ----------------------------------------------------
__int64 __fastcall sub_140003884(__int64 a1, __int64 a2, __int64 a3, int a4)//PTPFilterSendControlRequest(Request_a1, pDeviceContext_a2,  AmtPtpRequestCompletionRoutine_a3, _In_opt_PWDF_REQUEST_SEND_OPTIONS_a4);
{
  __int64 *v8; // rdi  //LONG * SEND_OPTIONS_v8;
  unsigned int v9; // ebx
  int v11; // [rsp+28h] [rbp-50h]
  __int64 v12[2]; // [rsp+30h] [rbp-48h] BYREF   //LONG v12[2];

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 5u, 0xBu, (__int64)&unk_140009180);
    DbgPrint("[PTP] %s : ", "PTPFilterSendControlRequest");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v8 = 0i64;//SEND_OPTIONS_v8=NULL;
  if ( a4 )  //_In_opt_PWDF_REQUEST_SEND_OPTIONS_a4
  {//下面几行是WDF_REQUEST_SEND_OPTIONS_INIT(&SendOptions_v8,WDF_REQUEST_SEND_OPTION_SEND_AND_FORGET)执行的联合结果??
    v8 = v12;  //SEND_OPTIONS_v8=LONG v12[];
    LODWORD(v12[0]) = 16;//=0x10  //WDF_REQUEST_SEND_OPTION_SYNCHRONOUS = 0x00000002,  + WDF_REQUEST_SEND_OPTION_SEND_AND_FORGET = 0x00000008,组合
    HIDWORD(v12[0]) = a4;//_In_opt_PWDF_REQUEST_SEND_OPTIONS_a4
    v12[1] = 0i64;
  }
  (*(void (__fastcall **)(__int64, __int64))(qword_14000A118 + 2008))(qword_14000A110, a1);//void WdfRequestFormatRequestUsingCurrentType(Request_a1);
  (*(void (__fastcall **)(__int64, __int64, __int64, __int64))(qword_14000A118 + 2080))(qword_14000A110, a1, a3, a2);//void WdfRequestSetCompletionRoutine(Request_a1, AmtPtpRequestCompletionRoutine_a3 ,pDeviceContext_a2);
  if ( (*(unsigned __int8 (__fastcall **)(__int64, __int64, _QWORD, __int64 *))(qword_14000A118 + 2024))(
         qword_14000A110,//ret= WdfRequestSend(_In_WDFREQUEST Request, _In_WDFIOTARGET Target,_In_opt_PWDF_REQUEST_SEND_OPTIONS Options)
         a1,  //Request_a1
         *(_QWORD *)(a2 + 16),  //pDeviceContext_a2->IoTarget,
         v8) )  //SEND_OPTIONS_v8
  {
    v9 = 0;
  }
  else
  {
    v9 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 2032))(qword_14000A110, a1);//status_v9 = WdfRequestGetStatus(Request_a1);
    v11 = v9;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 5u, 0xCu, (__int64)&unk_140009180, v11);
    DbgPrint("[PTP] %s : ", "PTPFilterSendControlRequest");
    DbgPrint("WdfRequestSend failed %!STATUS!", v9);
    DbgPrint("\n");
  }
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 5u, 0xDu, (__int64)&unk_140009180);
    DbgPrint("[PTP] %s : ", "PTPFilterSendControlRequest");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
  return v9;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140003A7C) ----------------------------------------------------
__int64 sub_140003A7C(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-48h]
  va_list va; // [rsp+98h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 140003B70: variable 'v12' is possibly undefined
// 140005E3C: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140003B90) ----------------------------------------------------
__int64 sub_140003B90(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-78h]
  va_list va; // [rsp+C8h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 140003D00: variable 'v12' is possibly undefined
// 140005E3C: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (0000000140003D28) ----------------------------------------------------
__int64 __fastcall sub_140003D28(__int64 a1, __int64 a2, __int64 a3)
//NTSTATUS PTPFilterCheckAndStartReadLoop(pDeviceContext_a1,Request_a2，CompletionRoutine_a3);
{
  unsigned int v6; // ebx
  int v7; // eax
  int v9; // [rsp+28h] [rbp-10h]

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 6u, 0xFu, (__int64)&unk_140009190);
    DbgPrint("[PTP] %s : ", "PTPFilterCheckAndStartReadLoop");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v6 = 0;//status_v6=STATUS_SUCCESS;
  if ( !*(_BYTE *)(a1 + 908) && !*(_BYTE *)(a1 + 920) )////!pDeviceContext_a1->RequestDataAvailableFlag && !pDeviceContext_a1->RequestLength;
  {
    *(_BYTE *)(a1 + 908) = 1;//pDeviceContext_a1->RequestDataAvailableFlag=TRUE;//可用TRUE
    sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 6u, 0x10u, (__int64)&unk_140009190);
    DbgPrint("[PTP] %s : ", "PTPFilterCheckAndStartReadLoop");
    DbgPrint("Read Loop Started");
    DbgPrint("\n");
    *(_QWORD *)(a1 + 24) = *(_QWORD *)//再次转为结构体配合+48i64调用成员
    	(*(_QWORD *)(//转换成结构体，配合+184调用成员
    	(*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 2280))(
                                                     qword_14000A110,///(/PIRP WdfRequestWdmGetIrp??//WDFFILEOBJECT WdfRequestGetFileObject(??WDFQUEUE WdfRequestGetIoQueue //  //
                                                     a2)// Request_a2
                  + 184)  //pHidPacket = (PHID_XFER_PACKET)pIrp->AssociatedIrp.SystemBuffer;//??//pHidPacket= pIrp->MdlAddress??
                                                        + 48i64);//pIrp->reportId

        
    v7 = sub_140003ED0((_QWORD *)a1, a3);//status_v7=PTPFilterSendReadRequest(pDeviceContext_a1, CompletionRoutine_a3);
    v6 = v7;
    if ( v7 < 0 )
    {
      v9 = v7;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 6u, 0x11u, (__int64)&unk_140009190, v9);
      DbgPrint("[PTP] %s : ", "PTPFilterCheckAndStartReadLoop");
      DbgPrint("PTPFilterSendReadRequest failed %!STATUS!", v6);
      DbgPrint("\n");
      *(_BYTE *)(a1 + 908) = 0;//pDeviceContext_a1->RequestDataAvailableFlag=FALSE;
    }
  }
  return v6;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140003ED0) ----------------------------------------------------
__int64 __fastcall sub_140003ED0(_QWORD *a1, __int64 a2)//PTPFilterSendReadRequest(pDeviceContext_a1, CompletionRoutine_a2);
{
  __int64 v4; // rdx
  int v5; // eax
  unsigned int v6; // ebx
  int v7; // eax
  int v9; // [rsp+28h] [rbp-50h]
  __int64 v10; // [rsp+28h] [rbp-50h]
  __int64 v11[4]; // [rsp+30h] [rbp-48h] BYREF

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 6u, 0xAu, (__int64)&unk_140009190);
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v4 = a1[96];//request_v4=pDeviceContext_a1->Request,
  // 下面3行为WDF_REQUEST_REUSE_PARAMS reuseParams;    WDF_REQUEST_REUSE_PARAMS_INIT(&reuseParams,WDF_REQUEST_REUSE_NO_FLAGS, STATUS_SUCCESS) 执行结果
  v11[2] = 0i64;
  v11[0] = 24i64;
  v11[1] = 0i64;
  
  v5 = (*(__int64 (__fastcall **)(__int64, __int64, __int64 *))(qword_14000A118 + 1992))(qword_14000A110, v4, v11);//
  //status_v5 =WdfRequestReuse(Request_v4, &reuseParams_v11);
  v6 = v5;
  if ( v5 < 0 )
  {
    v9 = v5;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 6u, 0xBu, (__int64)&unk_140009190, v9);
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("WdfRequestReuse failed %!STATUS!", v6);
LABEL_5:
    DbgPrint("\n");
    goto LABEL_10;
  }
  v7 = (*(__int64 (__fastcall **)(__int64, _QWORD, _QWORD, _QWORD, _QWORD, _QWORD))(qword_14000A118 + 1464))(
         qword_14000A110, //status_v7=WdfIoTargetFormatRequestForRead(
         a1[2],//pDeviceContext_a1->ioTarget,
         a1[96], //pDeviceContext_a1->Request,
         a1[97],//pDeviceContext_a1->OutputBuffer
         0i64, //OutputBufferOffset=0
         0i64);//DeviceOffset=0
  // 	
  v6 = v7;//status_v6= status_v7;
  if ( v7 < 0 )
  {
    LODWORD(v10) = v7;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 6u, 0xCu, (__int64)&unk_140009190, v10);
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("WdfIoTargetFormatRequestForRead failed %!STATUS!", v6);
    goto LABEL_5;
  }
  (*(void (__fastcall **)(__int64, _QWORD, __int64, _QWORD *))(qword_14000A118 + 2080))(qword_14000A110, a1[96], a2, a1);//void WdfRequestSetCompletionRoutine(Request_a1, AmtPtpRequestCompletionRoutine_a2 ,pDeviceContext_a1);
  *(_QWORD *)//再次转为结构体配合-24i64调用成员
  	  (*(_QWORD *)(//转换成结构体，配合+184调用成员
  (*(__int64 (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2280))(qword_14000A110, a1[96])//PIRP WdfRequestWdmGetIrp(pDeviceContext_a1->Request)
                        + 184)////pHidPacket = (PHID_XFER_PACKET)pIrp->AssociatedIrp.SystemBuffer;//??//pHidPacket= pIrp->MdlAddress??
            - 24i64) = a1[3];//=PLIST_ENTRY_a1[3];//结构体的成员
        //ULONG_PTR ppDeviceContext->lastx = Irp->IoStatus.Information;??
        //Irp->MdlAddress->ByteOffset;??
        //Irp->ThreadListEntry.Blink;//??
        //Irp->UserIosb->Pointer;??
        //Irp->Tail.Apc;??
        //Irp->AssociatedIrp.SystemBuffer??


            
  if ( !(*(unsigned __int8 (__fastcall **)(__int64, _QWORD, _QWORD, _QWORD))(qword_14000A118 + 2024))(
          qword_14000A110,//ret = WdfRequestSend(pDeviceContext_a1->Request, pDeviceContext_a1->ioTarget, &options);
          a1[96],//pDeviceContext_a1->Request
          a1[2],// //pDeviceContext_a1->ioTarget
          0i64) )  //WDF_REQUEST_SEND_OPTIONS =NULL      
  {
    v6 = (*(__int64 (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2032))(qword_14000A110, a1[96]);//status_v6 = WdfRequestGetStatus(pDeviceContext_a1->Request);
    LODWORD(v10) = v6;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 6u, 0xDu, (__int64)&unk_140009190, v10);
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("WdfRequestSend failed %!STATUS!", v6);
    goto LABEL_5;
  }
LABEL_10:
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 6u, 0xEu, (__int64)&unk_140009190);
    DbgPrint("[PTP] %s : ", "PTPFilterSendReadRequest");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
  return v6;
}
// 140004044: variable 'v10' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000419C) ----------------------------------------------------
ULONG __fastcall sub_14000419C(__int64 a1)//GettingButtonUsage(pDeviceContext_a1);
{
  USHORT *v1; // r9
  unsigned int v3; // edi
  ULONG result; // eax
  _WORD *v5; // rdx
  __int64 v6; // r8
  __int64 v7; // [rsp+28h] [rbp-20h]
  ULONG v8; // [rsp+50h] [rbp+8h] BYREF

  v1 = *(USHORT **)(a1 + 872);//PUSAGE UsageList_v1=pDeviceContext_a1->UsageListBuffer_872
  v8 = *(unsigned __int16 *)(a1 + 854);//PULONG UsageLength_v8=pDeviceContext_a1->UsageLength_854,
  //NTSTATUS_v3
  v3 = HidP_GetUsages(
         HidP_Input,//ReportType
         9u,//UsagePage =HID_USAGE_PAGE_BUTTON
         0,//LinkCollection
         v1,//UsageList_v1
         &v8,//UsageLength_v8
         *(PHIDP_PREPARSED_DATA *)(a1 + 800),//pDeviceContext_a1->PreparsedData_800,
         *(PCHAR *)(a1 + 784),//pDeviceContext_a1->PCHAR ReportBuffer_784,
         *(_DWORD *)(a1 + 792));//pDeviceContext_a1->ReportLength_792,
   
  *(_WORD *)(a1 + 760) = 0;
  *(_BYTE *)(a1 + 762) = 0;
  if ( v3 == 1114112 )//if NTSTATUS_v3==HIDP_STATUS_SUCCESS
  {
    result = v8;//result=UsageLength_v8
    if ( v8 )
    {
      v5 = *(_WORD **)(a1 + 872);//PVOID buffer_v5=pDeviceContext_a1->UsageListBuffer_872
      v6 = v8;//ULONG UsageLength_v6=UsageLength_v8
      do
      {
        switch ( *v5 )
        {
          case 1:
            *(_BYTE *)(a1 + 760) = 1;
            break;
          case 2:
            *(_BYTE *)(a1 + 761) = 1;
            break;
          case 3:
            *(_BYTE *)(a1 + 762) = 1;
            break;
        }
        ++v5;//++PVOID_buffer_v5
        --v6;////--UsageLength_v6
      }
      while ( v6 );
    }
  }
  else
  {
    LODWORD(v7) = v3;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 3u, 8u, 0x22u, (__int64)&unk_1400091A0, v7);
    DbgPrint("[PTP] %s : ", "DetectHardwareButtonStates");
    DbgPrint("output6: Error getting button usage, %!STATUS!", v3);
    result = DbgPrint("\n");
  }
  return result;
}
// 14000427F: variable 'v7' is possibly undefined

//----- (00000001400042BC) ----------------------------------------------------
__int64 __fastcall sub_1400042BC(__int64 a1, int a2)//PTPFilterCompleteControlRequest(pDeviceContext_a1, Buffer_a2);
{
  __int64 v2; // rdx
  int v4; // eax
  unsigned int v5; // ebx
  LONGLONG v6; // rax
  __int64 v7; // rdx
  int v8; // eax
  int v10; // [rsp+28h] [rbp-8h]
  int v11; // [rsp+28h] [rbp-8h]
  int v12; // [rsp+28h] [rbp-8h]
  size_t Size; // [rsp+50h] [rbp+20h] BYREF
  int v14; // [rsp+58h] [rbp+28h]
  __int64 v15; // [rsp+60h] [rbp+30h] BYREF
  void *Dst; // [rsp+68h] [rbp+38h] BYREF

  v14 = a2; //buffer_v14 = Buffer_a2
  v2 = *(_QWORD *)(a1 + 32);//pDeviceContext_a1->ReportQueue_32
  Dst = 0i64;
  Size = 0i64;
  v4 = (*(__int64 (__fastcall **)(__int64, __int64, __int64 *))(qword_14000A118 + 1264))(qword_14000A110, v2, &v15);//
  //v4 = WdfIoQueueRetrieveNextRequest(_In_WDFQUEUE pDeviceContext_a1->ReportQueue_32,Out_WDFREQUEST* OutRequest_Request_v15 );
  v5 = v4;
  if ( v4 >= 0 )
  {
    v6 = sub_14000186C();
    v7 = v15;
    *(_QWORD *)(a1 + 40) = v6;
    v8 = (*(__int64 (__fastcall **)(__int64, __int64, __int64, void **, size_t *))(qword_14000A118 + 2160))(
           qword_14000A110,//v8 = WdfRequestRetrieveOutputBuffer(Request_v15, MinimumRequiredLength, PVOID* outBuffer,size_t* Length);
           v7,
           1i64,
           &Dst,
           &Size);
    v5 = v8;
    if ( v8 >= 0 )
    {
      v12 = Size;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0xDu, (__int64)&unk_1400091A0, v12);
      DbgPrint("[PTP] %s : ", "PTPFilterCompleteControlRequest");
      DbgPrint("WdfRequestRetrieveOutputBuffer got control buffer with length: %d", (unsigned int)Size);
      DbgPrint("\n");
      if ( Size >= 4 )
      {
        memset(Dst, 0, Size);
        *(_DWORD *)Dst = v14; // Dst =buffer_v14 = Buffer_a2;
        (*(void (__fastcall **)(__int64, __int64, _QWORD, __int64))(qword_14000A118 + 2120))(
          qword_14000A110,//void WdfRequestCompleteWithInformation(
          v15,//Request_v15
          0i64,//Status_SUCCESS
          4i64);//ULONG_PTR Information_size
      }
      else
      {
        sub_140001294((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xEu, (__int64)&unk_1400091A0);
        DbgPrint("[PTP] %s : ", "PTPFilterCompleteControlRequest");
        DbgPrint("Buffer length is smaller than data");
        DbgPrint("\n");
        v5 = -1073741306;//status_v5=STATUS_INVALID_BUFFER_SIZE       ((NTSTATUS)0xC0000206L)
        (*(void (__fastcall **)(__int64, __int64, __int64, __int64))(qword_14000A118 + 2120))(//void WdfRequestCompleteWithInformation(Request_v15, NTSTATUS_code, ULONG_PTR Information_size)
          qword_14000A110,//void WdfRequestCompleteWithInformation(
          v15,//Request_v15
          3221225990i64, //STATUS_INVALID_BUFFER_SIZE       ((NTSTATUS)0xC0000206L)
          4i64);//ULONG_PTR Information_size
      }
    }
    else
    {
      v11 = v8;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xCu, (__int64)&unk_1400091A0, v11);
      DbgPrint("[PTP] %s : ", "PTPFilterCompleteControlRequest");
      DbgPrint("WdfRequestRetrieveOutputBuffer failed with status - %!STATUS!", v5);
      DbgPrint("\n");
      (*(void (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2104))(qword_14000A110, v15, v5);//void WdfRequestComplete(Request_v15,status_v5)
    }
  }
  else
  {
    v10 = v4;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xBu, (__int64)&unk_1400091A0, v10);
    DbgPrint("[PTP] %s : ", "PTPFilterCompleteControlRequest");
    DbgPrint("WdfIoQueueRetrieveNextRequest failed with status - %!STATUS!", v5);//WdfIoQueueRetrieveNextRequest(_In_WDFQUEUE Queue,Out_WDFREQUEST* OutRequest )
    DbgPrint("\n");
  }
  return v5;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140004528) ----------------------------------------------------
__int64 __fastcall sub_140004528(__int64 a1, const void *a2, size_t a3)//NTSTATUS PTPFilterCompleteReadRequest (Request_a1, sourceBuffer_a2, ULONG_PTR Information_size_a3)
{
  int v6; // eax
  unsigned int v7; // edi
  int v9; // [rsp+28h] [rbp-20h]
  void *Dst; // [rsp+30h] [rbp-18h] BYREF
  size_t Size; // [rsp+68h] [rbp+20h] BYREF

  v6 = (*(__int64 (__fastcall **)(__int64, __int64, size_t, void **, size_t *))(qword_14000A118 + 2160))(
         qword_14000A110,//v6 = WdfRequestRetrieveOutputBuffer(Request, MinimumRequiredLength, PVOID* outBuffer,size_t* Length);
         a1,
         a3,
         &Dst,
         &Size);
  v7 = v6;
  if ( v6 >= 0 )
  {
    memset(Dst, 0, Size);
    if ( Size >= a3 )
      memmove(Dst, a2, a3);//memmove(Dst,sourceBuffer_a2,size_a3);
    (*(void (__fastcall **)(__int64, __int64, _QWORD, size_t))(qword_14000A118 + 2120))(qword_14000A110, a1, 0i64, a3);
    //void WdfRequestCompleteWithInformation(Request_a1, NTSTATUS_code, ULONG_PTR Information_size_a3)
  }
  else
  {
    v9 = v6;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0xAu, (__int64)&unk_1400091A0, v9);
    DbgPrint("[PTP] %s : ", "PTPFilterCompleteReadRequest");
    DbgPrint("WdfRequestRetrieveOutputBuffer failed with status - %!STATUS!", v7);
    DbgPrint("\n");
  }
  return v7;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140004628) ----------------------------------------------------
__int64 __fastcall sub_140004628(__int64 a1)//PTPFilterFlushPendingRequests(pDeviceContext_a1)
{
  unsigned int v2; // ebx
  unsigned int v3; // edi
  int v4; // eax
  __int64 v6; // [rsp+28h] [rbp-10h]

  sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x12u, (__int64)&unk_1400091A0);
  DbgPrint("[PTP] %s : ", "PTPFilterFlushPendingRequests");
  DbgPrint("PTPFilterFlushPendingRequests");
  DbgPrint("\n");
  v2 = 0;
  v3 = 0;
  while ( *(_QWORD *)(a1 + 944) != a1 + 944 )//pDeviceContext_a1->LIST_ENTRY_944
  {
    v4 = sub_1400055B8(a1); // //status_v4 =PTPFilterProcessPendingRequest(pDeviceContext_a1);
    v3 = v4;
    if ( v4 < 0 )
      break;
    LODWORD(v6) = v4;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 0, 8u, 0x13u, (__int64)&unk_1400091A0, v6);
    DbgPrint("[PTP] %s : ", "PTPFilterFlushPendingRequests");
    DbgPrint("FLUSH - run PTPFilterProcessPendingRequest for report - %!STATUS!", v3);
    DbgPrint("\n");
  }
  if ( v3 != -2147483622 )////v3 != STATUS_GUARD_PAGE_VIOLATION      ((NTSTATUS)0x80000001L)
    v2 = v3;
  return v2;
}
// 1400046D9: variable 'v6' is possibly undefined

//----- (0000000140004734) ----------------------------------------------------
__int64 __fastcall sub_140004734(__int64 a1)
{
  __int64 result; // rax

  result = sub_140006130(a1 + 64);
  *(_DWORD *)(a1 + 900) = 0;//pDeviceContext_a1->LastFingerCount_900=0；
  *(_DWORD *)(a1 + 904) = 0;//pDeviceContext_a1->CurrentFingerCount_904=0；
  return result;
}

//----- (0000000140004764) ----------------------------------------------------
__int64 __fastcall sub_140004764(__int64 a1, int a2)
	//PTPFilterHandleCachedState(pDeviceContext_a1, a2 )
{
  unsigned int v2; // esi
  unsigned int v5; // eax

  v2 = 0;
  if ( *(_DWORD *)(a1 + 580) == 16 )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Du, (__int64)&unk_1400091A0);
    DbgPrint("[PTP] %s : ", "PTPFilterHandleCachedState");
    DbgPrint("PTPFilterProcessInputFrame canceled");
    DbgPrint("\n");
    v5 = sub_140004628(a1);//v5 = PTPFilterFlushPendingRequests(pDeviceContext_a1);
    *(_DWORD *)(a1 + 4) = 0;
    v2 = v5;
  }
  if ( a2 == 8 || a2 == 1 )//a2
  {
    if ( *(_DWORD *)(a1 + 572) == 2 && sub_14000186C() - *(_QWORD *)(a1 + 560) > (unsigned __int64)*(int *)(a1 + 84) )
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Eu, (__int64)&unk_1400091A0);
      DbgPrint("[PTP] %s : ", "PTPFilterHandleCachedState");
      DbgPrint("PTPFilterProcessInputFrame fingers up - DELETE ALL");
      DbgPrint("\n");
      sub_140001244((PLIST_ENTRY)(a1 + 944));//Delete_PLIST_ENTRY(pDeviceContext_a1->LIST_ENTRY_944);
    }
    else
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Fu, (__int64)&unk_1400091A0);
      DbgPrint("[PTP] %s : ", "PTPFilterHandleCachedState");
      DbgPrint("PTPFilterProcessInputFrame fingers up - FLUSH");
      DbgPrint("\n");
      v2 = sub_140004628(a1);  //v2 = PTPFilterFlushPendingRequests(pDeviceContext_a1);
    }
    *(_DWORD *)(a1 + 4) = 0;
  }
  return v2;
}

//----- (00000001400048E0) ----------------------------------------------------
__int64 __fastcall sub_1400048E0(__int64 a1)//NTSTATUS PTPFilterHandleDeviceData(pDeviceContext_a1)//处理设备数据
{
  __int64 v1; // rdx
  int v3; // eax
  unsigned int v4; // edi
  int v5; // edi
  unsigned __int16 v6; // r9
  int v7; // eax
  int v8; // eax
  __int64 v10; // [rsp+28h] [rbp-20h]
  int v11; // [rsp+28h] [rbp-20h]
  __int64 v12; // [rsp+28h] [rbp-20h]
  int v13; // [rsp+28h] [rbp-20h]
  unsigned __int8 v14; // [rsp+50h] [rbp+8h] BYREF
  char v15; // [rsp+58h] [rbp+10h] BYREF
  int v16; // [rsp+60h] [rbp+18h] BYREF

  v1 = *(_QWORD *)(a1 + 960);//ProcessedBufferSpinLock_v1=pDeviceContext_a1->ProcessedBufferSpinLock_960;
  v16 = 0;  //FingersCountValue_v16 =0;
  v15 = 0; //boolFlag_FingerNotChanged_v15 =FALSE;
  (*(void (__fastcall **)(__int64, __int64))(qword_14000A118 + 2528))(qword_14000A110, v1);//WdfSpinLockAcquire(ProcessedBufferSpinLock_v1);
  sub_14000419C(a1);//GettingButtonUsage(pDeviceContext_a1);
  v3 = sub_140001CF0(a1, (unsigned int *)&v16, &v15);  //PTPFilterGetFingersCount (pDeviceContext_a1,&CurrentFingersCountValue_v16 ,&boolFlag_FingerNotChanged_v15)
  v4 = v3;
  if ( v3 < 0 )
  {
    v11 = v3;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x23u, (__int64)&unk_1400091A0, v11);
    DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
    DbgPrint("PTPFilterGetFingersCount failed with status - %!STATUS!", v4);
    DbgPrint("\n");
    v5 = sub_1400010B4(a1 + 944, *(_WORD *)(a1 + 812), *(const void **)(a1 + 784), *(_DWORD *)(a1 + 792), v16);//此处已经获取到了手指输入报告后进行数据保存
    //status_v5 =PTPFilterBufferStoreReport(pDeviceContext_a1->LIST_ENTRY_944, pDeviceContext_a1->REPORT_BUFFER_SIZE_812 ,pDeviceContext_a1->PCHAR ReportBuffer_784,pDeviceContext_a1->ReportLength_792, CurrentFingersCountValue_v16);
    if ( v5 >= 0 )
    {
      sub_140001058((PLIST_ENTRY)(a1 + 928), (_LIST_ENTRY *)(a1 + 944), &v14);//pDeviceContext_a1->LIST_ENTRY_928, pDeviceContext_a1->LIST_ENTRY_944
      LODWORD(v10) = v14;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x25u, (__int64)&unk_1400091A0, v10);
      DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
      DbgPrint(
        "PTPFilterHandleDeviceData - No fingers in report. PTPFilterBufferProcessData, rawDataProcessed: %d",
        v14);
      DbgPrint("\n");
      v7 = sub_1400055B8(a1);  ////status_v7 =PTPFilterProcessPendingRequest(pDeviceContext_a1);
      v5 = v7;
      if ( v7 >= 0 )
        goto LABEL_13;
      LODWORD(v12) = v7;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x26u, (__int64)&unk_1400091A0, v12);
      DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
      DbgPrint("PTPFilterProcessPendingRequest failed with status - %!STATUS!", (unsigned int)v5);
      goto LABEL_5;
    }
    v6 = 36;
LABEL_4:
    LODWORD(v10) = v5;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, v6, (__int64)&unk_1400091A0, v10);
    DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
    DbgPrint("PTPFilterBufferStoreReport failed with status - %!STATUS!", (unsigned int)v5);
LABEL_5:
    DbgPrint("\n");
    goto LABEL_13;
  }
  v5 = sub_1400010B4(a1 + 928, *(_WORD *)(a1 + 812), *(const void **)(a1 + 784), *(_DWORD *)(a1 + 792), v16);//
  //status_v5 =PTPFilterBufferStoreReport(pDeviceContext_a1->LIST_ENTRY_928 ,pDeviceContext_a1->REPORT_BUFFER_SIZE_812 ,pDeviceContext_a1->PCHAR ReportBuffer_784,pDeviceContext_a1->ReportLength_792, CurrentFingersCountValue_v16);
  if ( v5 < 0 )
  {
    v6 = 39;
    goto LABEL_4;
  }
  if ( v15 )  //boolFlag_FingerNotChanged_v15
  {
    v8 = sub_1400053D0(a1);////status_v8 = PTPFilterProcessInputFrame(pDeviceContext_a1);
    v5 = v8;
    if ( v8 < 0 )
    {
      v13 = v8;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 3u, 8u, 0x28u, (__int64)&unk_1400091A0, v13);
      DbgPrint("[PTP] %s : ", "PTPFilterHandleDeviceData");
      DbgPrint("PTPFilterProcessInputFrame failed with status - %!STATUS!", (unsigned int)v5);
      DbgPrint("\n");
      *(_DWORD *)(a1 + 900) = 0;//pDeviceContext_a1->LastFingerCount_900=0；
      *(_DWORD *)(a1 + 904) = 0;//pDeviceContext_a1->CurrentFingerCount_904=0；
    }
  }
LABEL_13:
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 960));//WdfSpinLockRelease (pDeviceContext_a1->ProcessedBufferSpinLock_960);
  return (unsigned int)v5;
}
// 1400049E6: variable 'v10' is possibly undefined
// 140004ABD: variable 'v12' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140004BCC) ----------------------------------------------------
void __fastcall sub_140004BCC(__int64 a1, unsigned int a2, _BYTE *a3)//ptpfilterProcessReadReport(pDeviceContext_a1, status_a2, bRequestStopFlag_a3) 
{
  __int64 v6; // [rsp+30h] [rbp+8h] BYREF  //WDFREQUEST* OutRequest_v6;

  if ( *(_BYTE *)(a1 + 920) )//pDeviceContext_a1->RequestLength;
  {
    *(_BYTE *)(a1 + 908) = 0;//pDeviceContext_a1->RequestDataAvailableFlag=FALSE;
    *a3 = 0;//bRequestStopFlag_a3 = FALSE;////Pending_a3=FALSE;??
  }
  else
  {
    (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2528))(qword_14000A110, *(_QWORD *)(a1 + 912));////WdfSpinLockAcquire(pDeviceContext_a1->ReadLoopSpinLock_912);
    if ( (*(int (__fastcall **)(__int64, _QWORD, __int64 *))(qword_14000A118 + 1264))(
           qword_14000A110,//NTSTATUS WdfIoQueueRetrieveNextRequest(
           *(_QWORD *)(a1 + 56),////pDeviceContext_a1->ReportQueue_56
           &v6) //&OutRequest_v6
           	   >= 0 )
    {
      *a3 = 1;//bRequestStopFlag_a3 = TRUE;//Pending_a3=TRUE;??
      (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 912));////WdfSpinLockRelease (pDeviceContext_a1->ReadLoopSpinLock_912);
      (*(void (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2104))(qword_14000A110, v6, a2);//void WdfRequestComplete(OutRequest_v6,status_a2);
    }
    else
    {
      *(_BYTE *)(a1 + 908) = 0;//pDeviceContext_a1->RequestDataAvailableFlag=FALSE;
      *a3 = 0;//bRequestStopFlag_a3 = FALSE;////Pending_a3=FALSE;??
      (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 912));//WdfSpinLockRelease (pDeviceContext_a1->ReadLoopSpinLock_912);
    }
  }
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140004CAC) ----------------------------------------------------
bool __fastcall sub_140004CAC(__int64 a1, unsigned int a2)//PTPFilterHandlePotentialGesture(pDeviceContext_a1, a2 )
{
  bool v5; // zf
  int v6; // eax
  const char *v7; // rbx

  sub_140005FC4(a1 + 64, a2);
  switch ( a2 )
  {
    case 2u:
      *(_DWORD *)(a1 + 4) = *(_BYTE *)(a1 + 552) == 0;
      sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x18u, (__int64)&unk_1400091A0);
      DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
      DbgPrint("PTPFilterProcessInputFrame One finger down, waiting for gesture");
LABEL_3:
      DbgPrint("\n");
      return 1;
    case 4u:
      sub_140004628(a1); //PTPFilterFlushPendingRequests(pDeviceContext_a1);
LABEL_7:
      *(_DWORD *)(a1 + 4) = 0;
      return 1;
    case 5u:
      if ( *(_DWORD *)(a1 + 4) == 1 )
      {
        sub_140001244((PLIST_ENTRY)(a1 + 944));//Delete_PLIST_ENTRY(pDeviceContext_a1->LIST_ENTRY_944);
        sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x19u, (__int64)&unk_1400091A0);
        DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
        DbgPrint("PTPFilterProcessInputFrame TwoFingerStart, all one-finger reports are removed!");
        DbgPrint("\n");
      }
      *(_DWORD *)(a1 + 4) = 1;
      return 1;
  }
  if ( a2 - 6 <= 1 )
    return 1;
  if ( a2 == 9 )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Au, (__int64)&unk_1400091A0);
    DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
    DbgPrint("PTPFilterProcessInputFrame GestureType_ThreeFingerStart, all prior reports are removed!");
    DbgPrint("\n");
    sub_140001244((PLIST_ENTRY)(a1 + 944));//Delete_PLIST_ENTRY(pDeviceContext_a1->LIST_ENTRY_944);
    goto LABEL_7;
  }
  if ( a2 == 10 )
  {
    if ( *(_DWORD *)(a1 + 584) == 1 )
      sub_140002160(a1, (__int64 **)(a1 + 928));//PTPFilterRewritePosition(pDeviceContext_a1, pDeviceContext_a1->LIST_ENTRY_928)
    v5 = *(_DWORD *)(a1 + 572) == 10;
    return !v5;
  }
  if ( a2 - 11 <= 1 )
  {
    v7 = "Vertical";
    if ( a2 == 11 )
      v7 = "Horizontal";
    sub_140002EC4((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x1Bu, (__int64)&unk_1400091A0, v7);
    DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
    DbgPrint("PTPFilterProcessInputFrame GestureType_InternalThreeFingerMove, %s", v7);
    DbgPrint("\n");
    if ( *(_DWORD *)(a1 + 584) == 1 )
      sub_140002160(a1, (__int64 **)(a1 + 928));////PTPFilterRewritePosition(pDeviceContext_a1, pDeviceContext_a1->LIST_ENTRY_928)
    v5 = *(_DWORD *)(a1 + 572) == a2;
    return !v5;
  }
  if ( a2 <= 0xD )
  {
    v6 = 8450;
    if ( _bittest(&v6, a2) )
    {
      if ( *(_DWORD *)(a1 + 584) != 1 )
        return 1;
      sub_140001244((PLIST_ENTRY)(a1 + 944));//Delete_PLIST_ENTRY(pDeviceContext_a1->LIST_ENTRY_944);
      sub_140005808(
        (__int64)DeviceObject->DeviceExtension,
        4u,
        8u,
        0x1Cu,
        (__int64)&unk_1400091A0,
        a2,
        *(_DWORD *)(a1 + 572));
      DbgPrint("[PTP] %s : ", "PTPFilterHandlePotentialGesture");
      DbgPrint("PTPFilterProcessInputFrame potentialGesture %d, previousGesture %d", a2, *(unsigned int *)(a1 + 572));
      goto LABEL_3;
    }
  }
  return 0;
}

//----- (0000000140004F9C) ----------------------------------------------------
__int64 __fastcall sub_140004F9C(struct _LIST_ENTRY *a1, _BYTE *a2)
{
  int v3; // eax
  unsigned int v4; // ebx
  int v6; // [rsp+28h] [rbp-10h]

  sub_140001058(a1 + 58, a1 + 59, a2);
  v3 = sub_1400055B8((__int64)a1);////status_v3 =PTPFilterProcessPendingRequest(pDeviceContext_a1);
  v4 = v3;
  if ( v3 < 0 )
  {
    v6 = v3;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x17u, (__int64)&unk_1400091A0, v6);
    DbgPrint("[PTP] %s : ", "PTPFilterMoveReportsForward");
    DbgPrint("PTPFilterProcessPendingRequest failed with status - %!STATUS!", v4);
    DbgPrint("\n");
  }
  return v4;
}

//----- (000000014000502C) ----------------------------------------------------
void __fastcall sub_14000502C(__int64 a1, __int64 a2, __int64 a3, __int64 a4)// I/O 请求完成回调例程,,这里是读取数据完成的地方，可以自行修改数据分析处理流畅了
//Filter_EvtRequestIoctlCompletionRoutine_sub_14000502C(WDFREQUEST Request_a1, WDFIOTARGET Target_a2, PWDF_REQUEST_COMPLETION_PARAMS Params_a3, WDFCONTEXT pDeviceContext_a4)
{
  char v6; // si
  int v7; // eax
  unsigned int v8; // edi
  int v9; // eax
  unsigned int v10; // edi
  int v11; // eax
  unsigned int v12; // edi
  __int64 v13; // [rsp+28h] [rbp-30h]
  int v14; // [rsp+28h] [rbp-30h]
  int v15; // [rsp+28h] [rbp-30h]
  char v16; // [rsp+78h] [rbp+20h] BYREF

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 8u, 0x29u, (__int64)&unk_1400091A0);
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v6 = 1;
  v16 = 1;//bRequestStopFlag_v16=TRUE;////Pending_v16=TRUE;??
  v7 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 2032))(qword_14000A110, a1);//status_v7 = WdfRequestGetStatus(Request_a1);
  v8 = v7;//status_v8=status_v7;
  if ( v7 < 0 )
  {
    v14 = v7;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x2Au, (__int64)&unk_1400091A0, v14);
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("Read request failed with status - %!STATUS!", v8);
    DbgPrint("\n");
    sub_140004BCC(a4, v8, &v16);//ptpfilterProcessReadReport(pDeviceContext_a4,status_v8 ,&bRequestStopFlag_v16);////Pending_v16;??
    v6 = v16;//
    goto LABEL_7;
  }
  v9 = sub_1400048E0(a4);//status_v9=PTPFilterHandleDeviceData(pDeviceContext_a4);//此处获取输入报告数据并处理
  v10 = v9;
  if ( v9 < 0 )
  {
    v15 = v9;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x2Bu, (__int64)&unk_1400091A0, v15);
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("PTPFilterHandleDeviceData failed with status - %!STATUS!", v10);
    DbgPrint("\n");
LABEL_7:
    if ( !v6 )
      goto LABEL_10;
  }
  v11 = sub_140003ED0((_QWORD *)a4, (__int64)sub_14000502C);//status_v11=PTPFilterSendReadRequest(pDeviceContext_a4, &Filter_EvtRequestIoctlCompletionRoutine_sub_14000502C);
  v12 = v11;
  if ( v11 < 0 )
  {
    LODWORD(v13) = v11;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x2Cu, (__int64)&unk_1400091A0, v13);
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("PTPFilterSendReadRequest failed unexpectedly %!STATUS!", v12);
    DbgPrint("\n");
    *(_BYTE *)(a4 + 908) = 0;//pDeviceContext_a4->RequestDataAvailableFlag=FALSE;
  }
LABEL_10:
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 8u, 0x2Du, (__int64)&unk_1400091A0);
    DbgPrint("[PTP] %s : ", "PTPFilterOnDeviceDataAvailable");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
}
// 1400051D5: variable 'v13' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140005270) ----------------------------------------------------
__int64 __fastcall sub_140005270(__int64 a1, __int64 a2, _BYTE *a3)//NTSTATUS  PTPFilterProcessCurrentRequest(pDeviceContext_a1,Request_a2, bRequestForwardFlag);
{
  int v5; // edi
  struct _LIST_ENTRY *v7; // rcx
  PLIST_ENTRY v8; // rbx
  unsigned __int16 v9; // r9
  int v11; // [rsp+28h] [rbp-10h]

  v5 = 0;//status_v5 = STATUS_SUCCESS;
  *a3 = 0;//bRequestForwardFlag=FALSE;
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2528))(qword_14000A110, *(_QWORD *)(a1 + 960));//WdfSpinLockAcquire (pDeviceContext_a1->ProcessedBufferSpinLock_960);
  v7 = (struct _LIST_ENTRY *)(a1 + 944);//LIST_ENTRY_v7=pDeviceContext_a1->LIST_ENTRY_944;
  if ( v7->Flink != v7 )
  {
    v8 = RemoveHeadList(v7);//PLIST_ENTRY_v8=RemoveHeadList(LIST_ENTRY_v7);
    (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 960));//WdfSpinLockRelease (pDeviceContext_a1->ProcessedBufferSpinLock_960);
    v5 = sub_140004528(a2, v8[1].Blink, *(unsigned int *)(a1 + 792));//PTPFilterCompleteReadRequest (Request_a2, v8[1].Blink,  pDeviceContext_a1->ReportLength_792);
    sub_140001000(v8);//FreePool_PLIST_ENTRY(PLIST_ENTRY_v8)
    if ( v5 < 0 )
    {
      v9 = 15;
LABEL_7:
      v11 = v5;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, v9, (__int64)&unk_1400091A0, v11);
      DbgPrint("[PTP] %s : ", "PTPFilterProcessCurrentRequest");
      DbgPrint("WdfRequestForwardToIoQueue failed %!STATUS!", (unsigned int)v5);
      DbgPrint("\n");
      return (unsigned int)v5;
    }
    goto LABEL_8;
  }
  (*(void (__fastcall **)(__int64, _QWORD))(qword_14000A118 + 2536))(qword_14000A110, *(_QWORD *)(a1 + 960));//WdfSpinLockRelease (pDeviceContext_a1->ProcessedBufferSpinLock_960);
  if ( !*a3 )//bRequestForwardFlag
  {
    v5 = (*(__int64 (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 2248))(
           qword_14000A110,//status_v5 = WdfRequestForwardToIoQueue(
           a2,//Request_a2
           *(_QWORD *)(a1 + 56));////pDeviceContext_a1->ReportQueue_56
    if ( v5 < 0 )
    {
      v9 = 16;
      goto LABEL_7;
    }
LABEL_8:
    *a3 = 1;//bRequestForwardFlag=TRUE;
  }
  return (unsigned int)v5;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (00000001400053D0) ----------------------------------------------------
__int64 __fastcall sub_1400053D0(__int64 a1)//PTPFilterProcessInputFrame(pDeviceContext_a1)
{
  bool v2; // si
  int v3; // eax
  unsigned int v4; // ebx
  unsigned int v5; // eax
  char v7; // [rsp+58h] [rbp+28h] BYREF
  unsigned int v8; // [rsp+60h] [rbp+30h] BYREF

  v8 = 0;
  v7 = 0;
  v2 = 0;
  v3 = DoScreenSave();//
  v4 = v3;
  if ( v3 < 0 )
  {
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x20u, (__int64)&unk_1400091A0, v3);
    DbgPrint("[PTP] %s : ", "PTPFilterProcessInputFrame");
    DbgPrint("PTPFilterCreateContactsFromHidReport failed with status - %!STATUS!", v4);
    DbgPrint("\n");
    v5 = sub_140004F9C((struct _LIST_ENTRY *)a1, &v7);//pDeviceContext_a1, &v7
LABEL_14:
    v4 = v5;
    goto LABEL_15;
  }
  if ( !*(_BYTE *)a1 )
    goto LABEL_8;
  sub_140005F34(////RecognizerAddData(
    (_DWORD *)(a1 + 64),
    (__int64 *)(a1 + 592),
    (_BYTE *)(a1 + 760),
    (void (*)(const char *, ...))sub_140002C98);//RecognizerAddData(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...))
  sub_1400060A8((unsigned int *)(a1 + 64), &v8, (void (*)(const char *, ...))sub_140002C98);
  //GestureType_XXXFingerStart((unsigned int *)(a1 + 64), &v8, (void (*)(const char *, ...))sub_140002C98);
  if ( v8 )
  {
    v2 = sub_140004CAC(a1, v8);//v2 =PTPFilterHandlePotentialGesture(pDeviceContext_a1, v8 );
    sub_140006130(a1 + 64);
  }
  if ( *(_DWORD *)(a1 + 4) == 1 )
  {
    sub_140001058((PLIST_ENTRY)(a1 + 928), (_LIST_ENTRY *)(a1 + 944), &v7);//pDeviceContext_a1->LIST_ENTRY_928, pDeviceContext_a1->LIST_ENTRY_944;
    sub_140004764(a1, v8);//PTPFilterHandleCachedState(pDeviceContext_a1, v8 )
  }
  else
  {
LABEL_8:
    if ( *(_DWORD *)(a1 + 4) == 2 )
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 4u, 8u, 0x21u, (__int64)&unk_1400091A0);
      DbgPrint("[PTP] %s : ", "PTPFilterProcessInputFrame");
      DbgPrint("PTPFilterProcessInputFrame got FLUSH");
      DbgPrint("\n");
      sub_140001244((PLIST_ENTRY)(a1 + 944));//Delete_PLIST_ENTRY(pDeviceContext_a1->LIST_ENTRY_944);
      sub_140004628(a1);  //PTPFilterFlushPendingRequests(pDeviceContext_a1);
      *(_DWORD *)(a1 + 4) = 0;
    }
    v4 = sub_140004F9C((struct _LIST_ENTRY *)a1, &v7);
    if ( !v7 )
      v4 = sub_140004F9C((struct _LIST_ENTRY *)a1, &v7);
  }
  if ( v2 )
  {
    v5 = sub_140005690(a1, v8);//status_v5 = PTPFilterSendGestureToUserModeClient(pDeviceContext_a1, v8);//
    goto LABEL_14;
  }
LABEL_15:
  sub_140004734(a1);
  return v4;
}
// 1400019B0: using guessed type __int64 DoScreenSave(void);

//----- (00000001400055B8) ----------------------------------------------------
__int64 __fastcall sub_1400055B8(__int64 a1)//PTPFilterProcessPendingRequest(pDeviceContext_a1)
{
  int v2; // edi
  PLIST_ENTRY v3; // rbx
  int v5; // [rsp+28h] [rbp-10h]
  __int64 v6; // [rsp+40h] [rbp+8h] BYREF

  v2 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64 *))(qword_14000A118 + 1264))(
         qword_14000A110, ///status_v2 = WdfIoQueueRetrieveNextRequest(
         *(_QWORD *)(a1 + 56),////pDeviceContext_a1->ReportQueue_56
         &v6);//&OutRequest_v6

  if ( v2 >= 0 )
  {
    v3 = RemoveHeadList((PLIST_ENTRY)(a1 + 944));//PLIST_ENTRY_v3=RemoveHeadList(pDeviceContext_a1->LIST_ENTRY_944);
    v2 = sub_140004528(v6, v3[1].Blink, *(unsigned int *)(a1 + 792));//PTPFilterCompleteReadRequest (OutRequest_v6, v3[1].Blink,  pDeviceContext_a1->ReportLength_792);
    sub_140001000(v3);//FreePool_PLIST_ENTRY(PLIST_ENTRY_v3)
    if ( v2 < 0 )
    {
      v5 = v2;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x11u, (__int64)&unk_1400091A0, v5);
      DbgPrint("[PTP] %s : ", "PTPFilterProcessPendingRequest");
      DbgPrint("PTPFilterCompleteReadRequest failed with status - %!STATUS!", (unsigned int)v2);
      DbgPrint("\n");
    }
  }
  return (unsigned int)v2;
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (0000000140005690) ----------------------------------------------------
__int64 __fastcall sub_140005690(__int64 a1, unsigned int a2)
	//PTPFilterSendGestureToUserModeClient(pDeviceContext_a1, )
{
  int v3; // eax
  unsigned int v4; // ebx
  int v5; // eax
  unsigned int v7; // [rsp+28h] [rbp-10h]
  int v8; // [rsp+28h] [rbp-10h]
  int v9; // [rsp+50h] [rbp+18h] BYREF

  v3 = sub_140005FEC(a2, (unsigned int *)&v9);//Buffer_v9
  v4 = (unsigned __int16)v3 | 0xC0070000;
  if ( v3 <= 0 )
    v4 = v3;
  if ( (v4 & 0x80000000) != 0 )
  {
    v7 = v4;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 8u, 0x14u, (__int64)&unk_1400091A0, v7);
    DbgPrint("[PTP] %s : ", "PTPFilterSendGestureToUserModeClient");
    DbgPrint("RecognizerGetGestureData failed with status - %!STATUS!", v4);
LABEL_10:
    DbgPrint("\n");
    return v4;
  }
  v5 = sub_1400042BC(a1, v9);//v5 = PTPFilterCompleteControlRequest(pDeviceContext_a1, Buffer_v9);
  v4 = v5;
  if ( v5 < 0 )
  {
    if ( v5 != -2147483622 )  //v5 != STATUS_GUARD_PAGE_VIOLATION      ((NTSTATUS)0x80000001L)
    {
      *(_DWORD *)(a1 + 4) = 2;
      *(_BYTE *)a1 = 0;
      v8 = v5;
      sub_140002DD4((__int64)DeviceObject->DeviceExtension, 3u, 8u, 0x16u, (__int64)&unk_1400091A0, v8);
      DbgPrint("[PTP] %s : ", "PTPFilterSendGestureToUserModeClient");
      DbgPrint("PTPFilterCompleteControlRequest failed with status - %!STATUS!", v4);
      goto LABEL_10;
    }
    if ( *(_QWORD *)(a1 + 40) + 30i64 < (unsigned __int64)sub_14000186C() )
    {
      *(_DWORD *)(a1 + 4) = 2;
      *(_BYTE *)a1 = 0;
      sub_140001294((__int64)DeviceObject->DeviceExtension, 3u, 8u, 0x15u, (__int64)&unk_1400091A0);
      DbgPrint("[PTP] %s : ", "PTPFilterSendGestureToUserModeClient");
      DbgPrint("PTPFilterCompleteControlRequest queue was empty for 30ms, stopping filter");
      goto LABEL_10;
    }
  }
  return v4;
}

//----- (0000000140005808) ----------------------------------------------------
__int64 sub_140005808(__int64 a1, unsigned __int8 a2, unsigned int a3, unsigned __int16 a4, __int64 a5, ...)
{
  unsigned __int64 v8; // rdi
  int v10; // eax
  int v12; // [rsp+20h] [rbp-48h]
  va_list va; // [rsp+98h] [rbp+30h] BYREF

  va_start(va, a5);
  v8 = (unsigned __int64)a3 >> 16;
  v10 = *((_DWORD *)&DeviceObject->Timer + 20 * v8 + (((a3 - 1) >> 5) & 0x7FF) + 1);
  if ( _bittest(&v10, ((_BYTE)a3 - 1) & 0x1F) && *((_BYTE *)&DeviceObject->Timer + 80 * v8 + 1) >= a2 )
    qword_14000A0C8(*((_QWORD *)&DeviceObject->AttachedDevice + 10 * v8), 43i64, a5, a4, va);
  LOWORD(v12) = a4;
  return WppAutoLogTrace(a1, a2, a3, a5, v12, va);
}
// 1400058FC: variable 'v12' is possibly undefined
// 140005E3C: using guessed type __int64 __fastcall WppAutoLogTrace(_QWORD, _QWORD, _QWORD, _QWORD, _DWORD, _QWORD);
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);

//----- (000000014000591C) ----------------------------------------------------
__int64 __fastcall sub_14000591C(char a1, char a2, int a3, int a4)//double GetPhysicalValue(ULONG UnitsExp_a1, ULONG Units_a2, LONG PhysicalMax_a3, LONG PhysicalMin_a4);
{
  char v4; // cl
  unsigned int v6; // edi
  unsigned int v7; // er10
  _BYTE *v9; // rax
  unsigned int v10; // edx
  int v11; // edx
  unsigned __int16 v12; // si
  __int16 v13; // bx
  unsigned int v14; // eax
  int v15; // ebp

  v4 = a1 & 0xF;//UnitExponent_v4=UnitsExp_a1;
  v6 = 0;
  v7 = 0;
  v9 = word_1400091B0;//=UnitExponent_Table;
  do
  {
    if ( *v9 == v4 )
      break;
    ++v7;
    v9 += 4;
  }
  while ( v7 < 0xB );
  v10 = a2 & 0xF;
  if ( v10 < 5 )
  {
    v11 = dword_1400091E0[v10] - 1;//Unit_TABLE[v10]
    if ( v11 )
    {
      if ( v11 != 2 )
        return v6;
      v12 = 2540;
    }
    else
    {
      v12 = 1000;
    }
    if ( v7 < 0xB )
    {
      v13 = word_1400091B0[2 * v7 + 1];
      v14 = sub_1400059E4(v13);//=ExponentTransfor(v13)
      v15 = a3 - a4;
      if ( v13 >= 0 )
      {
        v6 = v14 * v15 * v12;
      }
      else if ( v14 )
      {
        v6 = v15 * (unsigned int)v12 / v14;
      }
    }
  }
  return v6;
}

//----- (00000001400059E4) ----------------------------------------------------
__int64 __fastcall sub_1400059E4(__int16 a1)//double ExponentTransfor(USHORT a1)
{
  int v1; // edx
  __int64 result; // rax  //double result;
  bool v3; // zf

  v1 = 10;
  result = 1i64;
  v3 = a1 == 0;
  if ( a1 < 0 )
  {
    a1 = -a1;
    v3 = a1 == 0;
  }
  if ( !v3 )
  {
    do
    {
      if ( (a1 & 1) != 0 )
        result = (unsigned int)(v1 * result);
      v1 *= v1;
      a1 >>= 1;
    }
    while ( a1 );
  }
  return result;
}

//----- (0000000140005B0C) ----------------------------------------------------
__int64 sub_140005B0C()///DriverU_exit?
{
  sub_140005DC4((__int64)&unk_14000A040);
  return WdfVersionUnbind(&DestinationString, &unk_14000A040, qword_14000A110);
}
// 14000695A: using guessed type __int64 __fastcall WdfVersionUnbind(_QWORD, _QWORD, _QWORD);
// 14000A110: using guessed type __int64 qword_14000A110;

//----- (0000000140005B68) ----------------------------------------------------
NTSTATUS __stdcall DriverEntry(_DRIVER_OBJECT *DriverObject, PUNICODE_STRING RegistryPath)
{
  NTSTATUS result; // eax
  NTSTATUS v5; // ebx
  __int64 (*v6)(void); // rax//void (__cdecl *v6)(_DRIVER_OBJECT *);

  if ( !DriverObject )
    return sub_14000E000(0i64, (__int64)RegistryPath);//return FxDriverEntryWorker(DriverObject_NULL, RegistryPath)
  qword_14000A120 = (__int64)DriverObject;//qword_14000A120=NULL
  DestinationString.Buffer = (PWSTR)&unk_14000A130;
  *(_DWORD *)&DestinationString.Length = 34078720;
  RtlCopyUnicodeString(&DestinationString, RegistryPath);
  result = WdfVersionBind(DriverObject, &DestinationString, &unk_14000A040, &qword_14000A110);//WdfBindInfo_unk_14000A040,&WdfDriverGlobals_qword_14000A110
  if ( result >= 0 )
  {
    qword_14000A128 = *(_QWORD *)(qword_14000A118 + 1608);
    v5 = sub_140005D2C((__int64)&unk_14000A040);//status_v5 = FxStubBindClasses(&WdfBindInfo_unk_14000A040);
    if ( v5 < 0
      || (v5 = sub_140005CC0(), v5 < 0)//(status_v5=FxStubInitTypes(),status_v5<0)
      || (v5 = sub_14000E000((__int64)DriverObject, (__int64)RegistryPath), v5 < 0) )//(v5 = FxDriverEntryWorker(DriverObject, RegistryPath), v5 < 0) )
    {
      sub_140005B0C();//DriverU_exit?
      result = v5;//status_v5
    }
    else
    {
      if ( *(_BYTE *)(qword_14000A110 + 48) )
      {
        v6 = qword_14000A108;
        if ( DriverObject->DriverUnload )
          v6 = (__int64 (*)(void))DriverObject->DriverUnload;
        qword_14000A108 = v6;
        DriverObject->DriverUnload = (PDRIVER_UNLOAD)sub_140005C98;//DriverUnload_sub_140005C98
      }
      else if ( (*(_DWORD *)(qword_14000A110 + 8) & 2) != 0 )
      {
        qword_14000A128 = (__int64)sub_140005C90;
      }
      result = 0;
    }
  }
  return result;
}
// 140005C90: using guessed type __int64 __fastcall sub_140005C90();
// 140006954: using guessed type __int64 __fastcall WdfVersionBind(_QWORD, _QWORD, _QWORD, _QWORD);
// 14000A108: using guessed type __int64 (*qword_14000A108)(void);
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;
// 14000A120: using guessed type __int64 qword_14000A120;
// 14000A128: using guessed type __int64 qword_14000A128;

//----- (0000000140005C98) ----------------------------------------------------
__int64 sub_140005C98()//DriverUnload_sub_140005C98
{
  if ( qword_14000A108 && qword_14000A108 != sub_140005C98 )
    qword_14000A108();
  return sub_140005B0C();///DriverU_exit?
}
// 14000A108: using guessed type __int64 (*qword_14000A108)(void);

//----- (0000000140005CC0) ----------------------------------------------------
__int64 sub_140005CC0()//FxStubInitTypes()
{
  __int64 result; // rax

  if ( &unk_14000A090 <= &unk_14000A0A0 )
    result = 0i64;
  else
    result = 3221225595i64;
  return result;
}

//----- (0000000140005D2C) ----------------------------------------------------
__int64 __fastcall sub_140005D2C(__int64 a1)//FxStubBindClasses(&WdfBindInfo);
{
  __int64 result; // rax
  _QWORD *i; // rbx
  __int64 (__fastcall *v4)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *); // rax

  result = 0i64;
  if ( &unk_14000A070 > (_UNKNOWN *)&qword_14000A080 )
    return 3221225595i64;
  for ( i = &qword_14000A080; i < &qword_14000A080; i += 10 )
  {
    if ( *(_DWORD *)i != 80 )
      return 3221225476i64;
    v4 = (__int64 (__fastcall *)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *))i[7];
    off_14000A088 = i;
    if ( v4 )
      result = v4(WdfVersionBindClass, a1, qword_14000A110, i);
    else
      result = WdfVersionBindClass(a1, qword_14000A110, i);
    if ( (int)result < 0 )
      return result;
  }
  return result;
}
// 140006960: using guessed type __int64 __fastcall WdfVersionBindClass(_QWORD, _QWORD, _QWORD);
// 14000A088: using guessed type void *off_14000A088;
// 14000A110: using guessed type __int64 qword_14000A110;

//----- (0000000140005DC4) ----------------------------------------------------
void *__fastcall sub_140005DC4(__int64 a1)
{
  void *result; // rax
  _QWORD *v2; // rbx
  __int64 (__fastcall *v4)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *); // rax

  result = off_14000A088;
  v2 = &qword_14000A080;
  if ( off_14000A088 != &unk_14000A070 && &qword_14000A080 <= off_14000A088 )
  {
    do
    {
      v4 = (__int64 (__fastcall *)(__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD), __int64, __int64, _QWORD *))v2[8];
      if ( v4 )
        result = (void *)v4(WdfVersionUnbindClass, a1, qword_14000A110, v2);
      else
        result = (void *)WdfVersionUnbindClass(a1, qword_14000A110, v2);
      v2 += 10;
    }
    while ( v2 <= off_14000A088 );
  }
  return result;
}
// 140006966: using guessed type __int64 __fastcall WdfVersionUnbindClass(_QWORD, _QWORD, _QWORD);
// 14000A088: using guessed type void *off_14000A088;
// 14000A110: using guessed type __int64 qword_14000A110;

//----- (0000000140005E50) ----------------------------------------------------
char __fastcall sub_140005E50(__int64 a1, int a2)
{
  char v2; // r8
  unsigned __int16 v3; // r9

  v2 = 1;
  v3 = 0;
  while ( *(_DWORD *)(32i64 * v3 + a1 + 16) == a2 )
  {
    if ( ++v3 >= 5u )
      return v2;
  }
  return 0;
}

//----- (0000000140005E80) ----------------------------------------------------
void __fastcall sub_140005E80(__int64 a1, __int64 a2, _BYTE *a3, int a4, void (*a5)(const char *, ...))
	//LIST_ENTRY_a1
{
  int v5; // er9
  int v6; // er9
  __int64 *v8; // r11
  int v9; // eax
  int v10; // ecx

  v5 = a4 - 1;
  if ( v5 )
  {
    v6 = v5 - 1;
    if ( v6 )
    {
      if ( v6 == 1 )
        sub_1400065FC(a1, a2, a5);
      else
        *(_DWORD *)(a1 + 516) = 16;
    }
    else
    {
      sub_1400063D4(a1, a2, (void (__fastcall *)(const char *))a5);
    }
  }
  else if ( *(_DWORD *)(a1 + 516) == 1 )
  {
    if ( *(_DWORD *)(a1 + 524) == 2 )
      *(_DWORD *)(a1 + 524) = 0;
    v8 = (__int64 *)(a2 + 8); //LIST_ENTRY_a2
    if ( *(_WORD *)(a2 + 32) == *(_WORD *)(a1 + 40) )//LIST_ENTRY_a2
    {
      v9 = *(_DWORD *)(a1 + 56);//// 
      v10 = *(_DWORD *)(a2 + 12) - *(_DWORD *)(a1 + 60);
      if ( (*(_DWORD *)v8 - v9) * (*(_DWORD *)v8 - v9) + v10 * v10 <= *(_DWORD *)(a1 + 24) )
      {
        if ( v9 < *(_DWORD *)(a1 + 8) || v9 > *(_DWORD *)(a1 + 12) || *a3 || a3[1] || a3[2] )////  LIST_ENTRY_a1->
        {
          *(_DWORD *)(a1 + 524) = 0;
          *(_DWORD *)(a1 + 516) = 16;
        }
        else
        {
          sub_1400061A0(a1 + 40, v8);
        }
      }
      else
      {
        *(_DWORD *)(a1 + 516) = 8;
        *(_DWORD *)(a1 + 524) = 4;
      }
    }
    else
    {
      *(_DWORD *)(a1 + 524) = 0;
      *(_DWORD *)(a1 + 516) = 16;
    }
  }
}

//----- (0000000140005EBC) ----------------------------------------------------
void *__fastcall sub_140005EBC(_DWORD *a1, int a2, int a3, __int64 (__fastcall *a4)(const char *))
{
  void *result; // rax
  int v5; // edx

  if ( !a3 )
    return sub_140006268(a1, a4);
  v5 = a2 - 2;
  if ( !v5 )
    return sub_140006528(a1, (void (__fastcall *)(const char *))a4);
  if ( v5 == 1 )
    return sub_140006838(a1, (void (__fastcall *)(const char *))a4);
  a1[129] = 16;
  return result;
}

//----- (0000000140005EF0) ----------------------------------------------------
__int64 __fastcall sub_140005EF0(__int64 a1, int a2)
{
  __int64 v2; // r8
  int v3; // edx

  v2 = *(__int16 *)(a1 + 100);
  v3 = 16 * a2;
  *(_DWORD *)(a1 + 96) += v3 - *(_DWORD *)(a1 + 4 * v2);
  *(_DWORD *)(a1 + 4 * v2) = v3;
  if ( (__int16)++*(_WORD *)(a1 + 100) >= 24 )
    *(_WORD *)(a1 + 100) = 0;
  return (unsigned int)((int)(((int)((unsigned __int64)(715827883i64 * *(int *)(a1 + 96)) >> 32) >> 2)
                            + ((unsigned int)((unsigned __int64)(715827883i64 * *(int *)(a1 + 96)) >> 32) >> 31)
                            + 8) >> 4);
}

//----- (0000000140005F34) ----------------------------------------------------
char __fastcall sub_140005F34(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...))
	//RecognizerAddData(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...))
{
  char result; // al

  if ( !a1[128] )
  {
    if ( (unsigned int)(a1[129] - 1) > 1 )
    {
      a1[128] = 0;
      a1[129] = 0;
      a1[131] = 0;
    }
    a1[128] = 1;
  }
  sub_1400061E0(a1, a2, a3, a4);
  result = sub_140005E50((__int64)a2, 0);
  if ( result )
  {
    if ( a4 )
      result = ((__int64 (__fastcall *)(const char *))a4)("RecognizerAddData - all fingers up");
    a1[8] = 0;
    a1[128] = 0;
    a1[130] = 0;
  }
  return result;
}

//----- (0000000140005FC4) ----------------------------------------------------
__int64 __fastcall sub_140005FC4(__int64 a1, int a2)
{
  __int64 result; // rax

  if ( a2 != 1 && a2 != 8 && a2 != 13 )
  {
    result = *(unsigned int *)(a1 + 504);
    *(_DWORD *)(a1 + 508) = result;
    *(_DWORD *)(a1 + 504) = a2;
  }
  return result;
}

//----- (0000000140005FEC) ----------------------------------------------------
__int64 __fastcall sub_140005FEC(unsigned int a1, unsigned int *a2)
{
  __int64 result; // rax

  result = 87i64;//USAGE(Surface switch) =0x57
  *a2 = 0;
  if ( a1 <= 0xD )
  {
    *a2 = a1;
    result = 0i64;
  }
  return result;
}

//----- (0000000140006004) ----------------------------------------------------
void *__fastcall sub_140006004(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *, __int64, _QWORD, __int64))
//(LIST_ENTRY_a1 , Physical_Length_X_a2
{
  __int64 v3; // r9
  __int64 v6; // [rsp+38h] [rbp+10h]

  v6 = a2;
  v3 = a2;
  if ( a3 )
  {
    a3("RecognizerInitialize", a2, a3, a2);
    v3 = v6;
  }
  *(_DWORD *)(a1 + 512) = 0;
  *(_DWORD *)(a1 + 516) = 0;
  *(_DWORD *)(a1 + 508) = 0;
  *(_DWORD *)(a1 + 504) = 0;
  *(_DWORD *)(a1 + 32) = 0;//LIST_ENTRY_a1->           =0;
  *(_QWORD *)(a1 + 496) = 0i64;
  *(_QWORD *)a1 = v3;
  *(_DWORD *)(a1 + 16) = 500;  //LIST_ENTRY_a1->    = 500;
  *(_DWORD *)(a1 + 20) = 200;
  *(_DWORD *)(a1 + 8) = (int)v3 / 10;  // LIST_ENTRY_a1->           = 
  *(_DWORD *)(a1 + 12) = v3 - (int)v3 / 10;
  *(_DWORD *)(a1 + 24) = 72900;
  *(_DWORD *)(a1 + 28) = 1444;
  *(_BYTE *)(a1 + 488) = 0;
  return memset((void *)(a1 + 40), 0, 0x1C0ui64);
}

//----- (00000001400060A8) ----------------------------------------------------
void __fastcall sub_1400060A8(unsigned int *a1, unsigned int *a2, void (*a3)(const char *, ...))
	//GestureType_XXXFingerStart(unsigned int *a1, unsigned int *a2, void (*a3)(const char *, ...))
{
  unsigned int v4; // ecx
  unsigned int v5; // eax
  unsigned int v6; // er8
  int v7; // eax

  if ( a1[129] != 1 )
  {
    if ( a1[129] == 2 )
    {
      v5 = a1[131];
      if ( v5 == 8 || v5 == 13 )
      {
        *a2 = v5;
        a1[131] = 0;
        return;
      }
    }
    else if ( a1[129] == 8 )
    {
      *a2 = a1[131];
      return;
    }
    v4 = 0;
    goto LABEL_15;
  }
  v6 = a1[131];
  if ( v6 > 9 || (v7 = 548, !_bittest(&v7, v6)) )
  {
    v4 = 0;
    if ( v6 - 10 <= 2 )
      v4 = v6;
LABEL_15:
    *a2 = v4;
    return;
  }
  *a2 = v6;
  if ( a3 )
    a3("Detected GestureType_XXXFingerStart with %d fingers", a1[8]);
}

//----- (0000000140006130) ----------------------------------------------------
__int64 __fastcall sub_140006130(__int64 a1)
{
  __int64 result; // rax

  result = (unsigned int)(*(_DWORD *)(a1 + 516) - 1);
  if ( (unsigned int)result > 1 )
  {
    result = 0i64;
    *(_QWORD *)(a1 + 512) = 0i64;
    *(_DWORD *)(a1 + 524) = 0;
  }
  return result;
}

//----- (0000000140006150) ----------------------------------------------------
__int64 __fastcall sub_140006150(__int64 a1, __int64 *a2, int a3, int a4, void (__fastcall *a5)(const char *))
{
  int v5; // er9
  int v6; // er9
  __int64 result; // rax

  v5 = a4 - 1;
  if ( !v5 )
    return sub_140006364(a1, (__int64)a2, a5);
  v6 = v5 - 1;
  if ( !v6 )
    return sub_140006568(a3, a1, a2, (__int64 (__fastcall *)(const char *))a5);
  if ( v6 == 1 )
    return sub_14000687C(a3, a1, a2, (__int64 (__fastcall *)(const char *))a5);
  *(_DWORD *)(a1 + 516) = 16;
  return result;
}

//----- (00000001400061A0) ----------------------------------------------------
__int64 __fastcall sub_1400061A0(__int64 a1, __int64 *a2)
{
  __int64 result; // rax

  *(_QWORD *)(a1 + 24) = a2[2];//LIST_ENTRY_a1->
  result = *a2;
  *(_QWORD *)(a1 + 32) = *a2;//LIST_ENTRY_a1->
  return result;
}

//----- (00000001400061B0) ----------------------------------------------------
__int64 __fastcall sub_1400061B0(__int64 a1, __int64 *a2)
{
  __int64 result; // rax

  *(_WORD *)a1 = *((_WORD *)a2 + 12);
  *(_QWORD *)(a1 + 8) = a2[2];  //LIST_ENTRY_a1
  *(_QWORD *)(a1 + 16) = *a2;  //LIST_ENTRY_a1->       = * a2;
  *(_QWORD *)(a1 + 24) = a2[2];
  *(_QWORD *)(a1 + 32) = *a2;//LIST_ENTRY_a1->
  result = *a2;
  *(_QWORD *)(a1 + 40) = *a2;
  return result;
}

//----- (00000001400061E0) ----------------------------------------------------
void __fastcall sub_1400061E0(_DWORD *a1, __int64 *a2, _BYTE *a3, void (*a4)(const char *, ...))
	//LIST_ENTRY_a1
{
  int v4; // er11
  int *v6; // rdx
  __int64 v7; // rdi
  int v8; // er10
  int v9; // eax
  int v10; // edx

  v4 = 0;
  v6 = (int *)(a2 + 2);
  v7 = 5i64;
  do
  {
    v8 = *v6;
    v9 = v4 + 1;
    v6 += 8;
    if ( v8 != 1 )
      v9 = v4;
    v4 = v9;
    --v7;
  }
  while ( v7 );
  v10 = a1[8];
  a1[8] = v9;
  if ( v9 <= v10 )
  {
    if ( v9 >= v10 )
      sub_140005E80((__int64)a1, (__int64)a2, a3, v9, a4);
    else
      sub_140005EBC(a1, v10, v9, (__int64 (__fastcall *)(const char *))a4);
  }
  else
  {
    sub_140006150((__int64)a1, a2, v10, v9, (void (__fastcall *)(const char *))a4);
  }
}

//----- (000000014000625C) ----------------------------------------------------
__int64 __fastcall sub_14000625C(__int64 a1, _DWORD *a2)
{
  __int64 result; // rax

  *(_DWORD *)(a1 + 40) += *a2;
  result = (unsigned int)a2[1];
  *(_DWORD *)(a1 + 44) += result;
  return result;
}

//----- (0000000140006268) ----------------------------------------------------
void *__fastcall sub_140006268(_DWORD *a1, __int64 (__fastcall *a2)(const char *))
{
  void *result; // rax

  a1[129] = 8;
  a1[131] = 1;
  result = memset(a1 + 10, 0, 0xF0ui64);
  if ( a2 )
    result = (void *)a2("Detected GestureType_AllFingerEnd");
  return result;
}

//----- (0000000140006364) ----------------------------------------------------
__int64 __fastcall sub_140006364(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *))
{
  unsigned __int64 v5; // r8
  unsigned __int64 v6; // rax

  if ( a3 )
    a3("One finger gesture start");
  v5 = *(int *)(a1 + 16);  //LIST_ENTRY_a1
  *(_DWORD *)(a1 + 516) = 1;
  *(_DWORD *)(a1 + 524) = 2;
  v6 = *(_QWORD *)(a2 + 24) - *(_QWORD *)(a1 + 496);
  *(_QWORD *)(a1 + 496) = *(_QWORD *)(a2 + 24);
  *(_BYTE *)(a1 + 488) = v6 < v5;
  return sub_1400061B0(a1 + 40, (__int64 *)(a2 + 8));  //LIST_ENTRY_a1
}

//----- (00000001400063D4) ----------------------------------------------------
void __fastcall sub_1400063D4(__int64 a1, __int64 a2, void (__fastcall *a3)(const char *))
	//LIST_ENTRY_a1 ,LIST_ENTRY_a2 ??
	
{
  int v4; // ecx
  int v5; // edi
  int v6; // er11
  int v7; // eax
  int v8; // edi
  int v9; // ecx
  int v10; // er11
  const char *v11; // rcx
  unsigned __int64 v12; // r10
  unsigned __int64 v13; // rcx
  unsigned __int64 v14; // rbx

  if ( *(_DWORD *)(a1 + 516) == 1 )
  {
    if ( *(_DWORD *)(a1 + 524) == 5 )
      *(_DWORD *)(a1 + 524) = 0;
    if ( *(_WORD *)(a1 + 40) == *(_WORD *)(a2 + 32) && *(_WORD *)(a1 + 88) == *(_WORD *)(a2 + 64) )//pDeviceContext_a2->ReportQueue_32
    {
      v4 = *(_DWORD *)(a2 + 8) - *(_DWORD *)(a1 + 56);///LIST_ENTRY_a1
      v5 = *(_DWORD *)(a2 + 12) - *(_DWORD *)(a1 + 60);
      v6 = *(_DWORD *)(a2 + 44) - *(_DWORD *)(a1 + 108);
      v7 = *(_DWORD *)(a1 + 24);
      v8 = v4 * v4 + v5 * v5;
      v9 = *(_DWORD *)(a2 + 40) - *(_DWORD *)(a1 + 104);
      v10 = v9 * v9 + v6 * v6;
      if ( v8 > v7 && v10 > v7 )
      {
        *(_DWORD *)(a1 + 516) = 8;
        *(_DWORD *)(a1 + 524) = 7;
        if ( !a3 )
          return;
        v11 = "Detected GestureType_TwoFingersDrag (distance)";
        goto LABEL_16;
      }
      v12 = *(_QWORD *)(a2 + 24) - *(_QWORD *)(a1 + 48);
      v13 = *(_QWORD *)(a2 + 56) - *(_QWORD *)(a1 + 96);//LIST_ENTRY_a2
      if ( *(_QWORD *)(a2 + 24) != *(_QWORD *)(a1 + 48) && v13 )
      {
        v14 = *(int *)(a1 + 28);
        if ( v8 / v12 > v14 && v10 / v13 > v14 )
        {
          *(_DWORD *)(a1 + 516) = 8;
          *(_DWORD *)(a1 + 524) = 7;
          if ( !a3 )
            return;
          v11 = "Detected GestureType_TwoFingersDrag (velocity)";
          goto LABEL_16;
        }
        if ( v12 > 0x64 || v13 > 0x64 )
        {
          *(_DWORD *)(a1 + 516) = 8;
          *(_DWORD *)(a1 + 524) = 7;
          if ( a3 )
          {
            v11 = "Detected GestureType_TwoFingersHeld";
LABEL_16:
            a3(v11);
            return;
          }
        }
      }
    }
    else
    {
      *(_DWORD *)(a1 + 516) = 16;
    }
  }
}

//----- (0000000140006528) ----------------------------------------------------
void *__fastcall sub_140006528(_DWORD *a1, void (__fastcall *a2)(const char *))
{
  if ( a2 )
    a2("Detected GestureType_TwoFingerEnd");
  a1[129] = 2;
  a1[131] = 8;
  return memset(a1 + 22, 0, 0x30ui64);
}

//----- (0000000140006568) ----------------------------------------------------
__int64 __fastcall sub_140006568(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *))
{
  __int64 result; // rax

  if ( *(_DWORD *)(a2 + 516) <= 1u )
  {
    if ( a4 )
      result = a4("Two finger gesture start");
    if ( a1 == 1 )
    {
      if ( (unsigned __int64)(a3[3] - *(_QWORD *)(a2 + 48)) > 0x64 )
      {
        *(_DWORD *)(a2 + 524) = 0;
        *(_DWORD *)(a2 + 516) = 16;
        return result;
      }
    }
    else
    {
      sub_1400061B0(a2 + 40, a3 + 1);
    }
    result = sub_1400061B0(a2 + 88, a3 + 5);
    *(_DWORD *)(a2 + 516) = 1;
    *(_DWORD *)(a2 + 524) = 5;
  }
  return result;
}

//----- (00000001400065FC) ----------------------------------------------------
void __fastcall sub_1400065FC(__int64 a1, __int64 a2, void (*a3)(const char *, ...))
{
  int v3; // ebx
  __int16 v6; // ax
  _DWORD *v7; // r10
  _DWORD *v8; // r11
  __int16 v9; // ax
  unsigned int v10; // er12
  unsigned int v11; // eax
  int v12; // ecx
  int v13; // er9
  int v14; // er8
  int v15; // edx
  int v16; // er14
  int v17; // er15
  int v18; // ecx
  __int64 v19; // rsi
  __int64 v20; // rbx
  unsigned __int64 v21; // [rsp+20h] [rbp-30h] BYREF
  __int64 v22; // [rsp+28h] [rbp-28h]
  __int64 v23; // [rsp+30h] [rbp-20h]
  __int64 *v24; // [rsp+38h] [rbp-18h]
  __int64 *v25; // [rsp+40h] [rbp-10h]
  __int64 *v26; // [rsp+48h] [rbp-8h]
  unsigned __int64 v27; // [rsp+90h] [rbp+40h] BYREF
  __int64 v28; // [rsp+A8h] [rbp+58h] BYREF

  v3 = 0;
  if ( *(_DWORD *)(a1 + 524) == 9 )
    *(_DWORD *)(a1 + 524) = 0;
  if ( *(_DWORD *)(a1 + 516) == 1 )
  {
    if ( *(_DWORD *)(a1 + 520) == 1 )
    {
      v6 = *(_WORD *)(a2 + 32);//LIST_ENTRY_a2
      v7 = (_DWORD *)(a2 + 40);
      v8 = (_DWORD *)(a2 + 72);
      v24 = (__int64 *)(a2 + 8);  //LIST_ENTRY_a2
      v25 = (__int64 *)(a2 + 40);
      v26 = (__int64 *)(a2 + 72);
      v23 = a1 + 40;
      if ( *(_WORD *)(a1 + 40) == v6
        && *(_WORD *)(a1 + 88) == *(_WORD *)(a2 + 64)
        && (v9 = *(_WORD *)(a2 + 96), v22 = a1 + 136, *(_WORD *)(a1 + 136) == v9) )
      {
        v10 = 0;
        v27 = 0i64;
        v11 = 0;
        v28 = 0i64;
        v21 = 0i64;
        if ( *(_QWORD *)(a1 + 64) && *(_QWORD *)(a1 + 112) && *(_QWORD *)(a1 + 160) )
        {
          v12 = *(_DWORD *)(a2 + 12) - *(_DWORD *)(a1 + 76);
          v13 = *(_DWORD *)(a2 + 8) - *(_DWORD *)(a1 + 72); //LIST_ENTRY_a2
          v14 = *v7 - *(_DWORD *)(a1 + 120);
          v15 = *v8 - *(_DWORD *)(a1 + 168);
          HIDWORD(v28) = v7[1] - *(_DWORD *)(a1 + 124);
          v21 = __PAIR64__(v8[1] - *(_DWORD *)(a1 + 172), v15);
          v27 = __PAIR64__(v12, v13);
          LODWORD(v28) = v14;
          v10 = sub_140005EF0(a1 + 280, v13 + v14 + v15);
          v11 = sub_140005EF0(a1 + 384, HIDWORD(v27) + HIDWORD(v21) + HIDWORD(v28));
        }
        v16 = v10 * v10;
        v17 = v11 * v11;
        v18 = v11 * v11 + v10 * v10;
        if ( a3 )
        {
          a3("3 fingers, x: %d, y: %d - avg: %d", v10, v11, (unsigned int)v18, v21);
          v18 = v17 + v16;
        }
        if ( v18 <= 50 )
        {
          v20 = v22;
          v19 = v23;
          *(_DWORD *)(a1 + 524) = 10;
        }
        else
        {
          v19 = a1 + 40;
          LOBYTE(v3) = v16 <= v17;
          *(_DWORD *)(a1 + 524) = v3 + 11;
          sub_14000625C(a1 + 40, &v27);
          sub_14000625C(a1 + 88, &v28);
          v20 = a1 + 136;
          sub_14000625C(a1 + 136, &v21);
        }
        sub_1400061A0(v19, v24);
        sub_1400061A0(a1 + 88, v25);
        sub_1400061A0(v20, v26);
      }
      else
      {
        *(_DWORD *)(a1 + 516) = 16;
      }
    }
    else if ( a3 )
    {
      a3("3 fingers, but not slow mode");
    }
  }
}

//----- (0000000140006838) ----------------------------------------------------
void *__fastcall sub_140006838(_DWORD *a1, void (__fastcall *a2)(const char *))
{
  if ( a2 )
    a2("Three finger gesture end");
  a1[129] = 2;
  a1[131] = 13;
  return memset(a1 + 34, 0, 0x30ui64);
}

//----- (000000014000687C) ----------------------------------------------------
__int64 __fastcall sub_14000687C(int a1, __int64 a2, __int64 *a3, __int64 (__fastcall *a4)(const char *))
{
  __int64 result; // rax
  int v8; // edi

  if ( *(_DWORD *)(a2 + 516) <= 1u )
  {
    if ( a4 )
      result = a4("Three finger gesture start");
    if ( a1 )
    {
      v8 = a1 - 1;
      if ( v8 )
      {
        if ( v8 == 1
          && ((unsigned __int64)(a3[3] - *(_QWORD *)(a2 + 48)) > 0x64
           || (unsigned __int64)(a3[7] - *(_QWORD *)(a2 + 96)) > 0x64) )
        {
          goto LABEL_11;
        }
        goto LABEL_14;
      }
      if ( (unsigned __int64)(a3[3] - *(_QWORD *)(a2 + 48)) > 0x64 )
      {
LABEL_11:
        *(_DWORD *)(a2 + 524) = 0;
        *(_DWORD *)(a2 + 516) = 16;
        return result;
      }
    }
    else
    {
      sub_1400061B0(a2 + 40, a3 + 1);
    }
    sub_1400061B0(a2 + 88, a3 + 5);
LABEL_14:
    result = sub_1400061B0(a2 + 136, a3 + 9);
    *(_DWORD *)(a2 + 516) = 1;
    *(_DWORD *)(a2 + 524) = 9;
  }
  return result;
}

//----- (000000014000D000) ----------------------------------------------------
__int64 __fastcall sub_14000D000(__int64 a1)//NTSTATUS PTPFilterCreateDevice(DeviceInit_a1);
{
  int v1; // eax
  int v2; // ebx
  __int64 v3; // rdi
  __int64 v4; // rax
  unsigned __int16 v5; // r9
  int v6; // eax
  int v7; // eax
  int v8; // eax
  int v10; // [rsp+20h] [rbp-E0h]
  __int64 v11[12]; // [rsp+30h] [rbp-D0h] BYREF
  _QWORD v12[8]; // [rsp+90h] [rbp-70h] BYREF  // WDF_OBJECT_ATTRIBUTES DeviceAttributes_v12;
  __int64 Dst[24]; // [rsp+D0h] [rbp-30h] BYREF//WDF_PNPPOWER_EVENT_CALLBACKS pnpPowerCallbacks_Dst;
  __int64 v14; // [rsp+1A0h] [rbp+A0h] BYREF
  __int64 v15; // [rsp+1A8h] [rbp+A8h] BYREF
  char v16; // [rsp+1B0h] [rbp+B0h] BYREF

  v14 = a1;//DeviceInit_v14=DeviceInit_a1;
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 2u, 0xAu, (__int64)&unk_140009140);
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
    a1 = v14;
  }
  (*(void (__fastcall **)(__int64, __int64))(qword_14000A118 + 1032))(qword_14000A110, a1);//WdfFdoInitSetFilter(DeviceInit_a1);//经过对比测试排除了WdfPdoInitAllowForwardingRequestToParent(DeviceInit);和WdfDeviceInitSetPowerPageable(DeviceInit);
  (*(void (__fastcall **)(__int64, __int64, _QWORD))(qword_14000A118 + 456))(qword_14000A110, v14, 0i64);//WdfDeviceInitSetIoType(DeviceInit_14,WdfDeviceIoUndefined);
  
  //下面2行是WDF_PNPPOWER_EVENT_CALLBACKS_INIT(&pnpPowerCallbacks_Dst)执行的结果;
  memset(Dst, 0, 0x90ui64);//
   LODWORD(Dst[0]) = 144;//pnpPowerCallbacks_Dst.size=
    
  Dst[5] = (__int64)sub_140001354;//pnpPowerCallbacks_Dst.EvtDevicePrepareHardware=PTPFilterDevicePrepareHardware;
  Dst[6] = (__int64)sub_14000167C;//pnpPowerCallbacks_Dst.EvtDeviceReleaseHardware= PTPFilterDeviceReleaseHardware;

  (*(void (__fastcall **)(__int64, __int64, __int64 *))(qword_14000A118 + 440))(qword_14000A110, v14, Dst);//WdfDeviceInitSetPnpPowerEventCallbacks(DeviceInit_14, &pnpPowerCallbacks_Dst);
  
  ////下面4行实际是WDF_OBJECT_ATTRIBUTES_INIT_CONTEXT_TYPE(&DeviceAttributes_v12, DEVICE_CONTEXT);执行的联合效果;
  memset(v12, 0, 0x38ui64);// 
  v12[3] = 0x100000001i64;//DeviceAttributes_v12.
  v12[6] = off_14000A018;//DeviceAttributes_v12.   =DEVICE_CONTEXT
  LODWORD(v12[0]) = 56;//DeviceAttributes_v12.
  
  v1 = (*(__int64 (__fastcall **)(__int64, __int64 *, _QWORD *, __int64 *))(qword_14000A118 + 600))(
         qword_14000A110, //Status_v1 = WdfDeviceCreate(
         &v14,//DeviceInit_v14
         v12,//DeviceAttributes_v12
         &v15);//&Device_v15
  //Status_v1 = WdfDeviceCreate(&DeviceInit_v14, &DeviceAttributes_v12, &Device_v15);
  v2 = v1;
  if ( v1 < 0 )//if (!NT_SUCCESS(Status)) 
  {
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0xBu, (__int64)&unk_140009140, v1);
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("WdfDeviceCreate failed %!STATUS!", (unsigned int)v2);
LABEL_5:
    DbgPrint("\n");
    goto LABEL_20;
  }
  v3 = (*(__int64 (__fastcall **)(__int64, __int64, void *))(qword_14000A118 + 1616))(
         qword_14000A110,
         v15,//Device_v15
         off_14000A018);//pDeviceContext_v3 = GetDeviceContext(Device_v15);
  *(_QWORD *)(v3 + 8) = v15;//pDeviceContext_v3->hDevice=Device_v15;
  v4 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 336))(qword_14000A110, v15);//IoTarget_v4 = WdfDeviceGetIoTarget(Device_v15);
  *(_BYTE *)(v3 + 908) = 0;//pDeviceContext_v3->RequestDataAvailableFlag=FALSE;
  *(_QWORD *)(v3 + 16) = v4;//pDeviceContext_v3->IoTarget=IoTarget_v4;
  *(_BYTE *)(v3 + 920) = 0;////pDeviceContext_v3->RequestLength=0;
  
  //下5行WDF_IO_QUEUE_CONFIG_INIT_DEFAULT_QUEUE(&queueConfig_v11, WdfIoQueueDispatchParallel)执行的联合结果，不要分开单独编写
  memset(v11, 0, sizeof(v11));
  LODWORD(v11[10]) = -1;//Config->Settings.Parallel.NumberOfPresentedRequests = (ULONG)-1;  
    LODWORD(v11[0]) = 96;//queueConfig_v11.NumberOfPresentedRequests=96;??queueConfig_v11.Size=96;??
  BYTE5(v11[1]) = 1;//queueConfig_v11.DefaultQueue=TRUE;//queueConfig.PowerManaged = WdfTrue;???
  *(__int64 *)((char *)v11 + 4) = 2i64;//queueConfig_v11.DispatchType = WdfIoQueueDispatchParallel;
  
  v11[5] = (__int64)sub_14000310C;//queueConfig_v11..EvtIoDeviceControl = PTPFilterEvtIoDeviceControl;
  v11[3] = (__int64)sub_140003630;//queueConfig_v11.EvtIoRead = PTPFilterEvtIoRead;

  v2 = (*(__int64 (__fastcall **)(__int64, __int64, __int64 *, _QWORD, char *))(qword_14000A118 + 1216))(
         qword_14000A110,  //status_v2 = WdfIoQueueCreate(
         v15,  //Device_v15
         v11,  //&queueConfig_v11
         0i64,  //WDF_NO_OBJECT_ATTRIBUTES
         &v16);  //&queue_v16

  if ( v2 < 0 )
  {
    v5 = 12;//errcode_status_v5=
LABEL_8:
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, v5, (__int64)&unk_140009140, v2);
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("WdfIoQueueCreate failed %!STATUS!", (unsigned int)v2);
    goto LABEL_5;
  }
  
  ////下面3行为WDF_IO_QUEUE_CONFIG_INIT(&queueConfig_v11, WdfIoQueueDispatchManual)执行的联合结果，不要分开编写;
  memset(v11, 0, sizeof(v11));
  LODWORD(v11[0]) = 96;//queueConfig_v11.NumberOfPresentedRequests=96;??queueConfig_v11.Size=96;??
  *(__int64 *)((char *)v11 + 4) = 3i64;//queueConfig_v11.DispatchType = WdfIoQueueDispatchManual;
  
  v2 = (*(__int64 (__fastcall **)(__int64, __int64, __int64 *, _QWORD, __int64))(qword_14000A118 + 1216))(
         qword_14000A110,//status_v2 = WdfIoQueueCreate(
         v15,//Device_v15
         v11,//queueConfig_v11
         0i64,//WDF_NO_OBJECT_ATTRIBUTES
         v3 + 32);//pDeviceContext_v3->ReportQueue_32
  if ( v2 < 0 )
  {
    v5 = 13;
    goto LABEL_8;
  }
  
    ////下面3行为WDF_IO_QUEUE_CONFIG_INIT(&queueConfig_v11, WdfIoQueueDispatchManual);执行的联合结果，不要分开编写;
  memset(v11, 0, sizeof(v11));//
  LODWORD(v11[0]) = 96;//queueConfig_v11.NumberOfPresentedRequests=96;??queueConfig_v11.Size=96;??
  *(__int64 *)((char *)v11 + 4) = 3i64;////queueConfig_v11.DispatchType = WdfIoQueueDispatchManual;
  
  v2 = (*(__int64 (__fastcall **)(__int64, __int64, __int64 *, _QWORD, __int64))(qword_14000A118 + 1216))(
         qword_14000A110,//status_v2 = WdfIoQueueCreate(
         v15,//Device_v15
         v11,//queueConfig_v11
         0i64,//WDF_NO_OBJECT_ATTRIBUTES
         v3 + 56);//pDeviceContext_v3->ReportQueue_56
  if ( v2 < 0 )
  {
    v5 = 14;
    goto LABEL_8;
  }
  sub_140001038((_QWORD *)v3);//pDeviceContext_v3  //测试
  
  v6 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64))(qword_14000A118 + 2520))(qword_14000A110, 0i64, v3 + 912);
  //status_v6=WdfSpinLockCreate( NULL, pDeviceContext_v3->ReadLoopSpinLock_912);
  v2 = v6;//Status_v2=Status_v6
  if ( v6 < 0 )
  {
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0xFu, (__int64)&unk_140009140, v6);//NTSTATUS WppTraceCallback(....
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("WdfSpinLockCreate for ReadLoopSpinLock failed %!STATUS!", (unsigned int)v2);
    goto LABEL_5;
  }
  v7 = (*(__int64 (__fastcall **)(__int64, _QWORD, __int64))(qword_14000A118 + 2520))(qword_14000A110, 0i64, v3 + 960);
  //status_v7=WdfSpinLockCreate( NULL, pDeviceContext_v3->ProcessedBufferSpinLock_960);
  v2 = v7;//status_v2=status_v7;
  if ( v7 < 0 )
  {
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x10u, (__int64)&unk_140009140, v7);
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("WdfSpinLockCreate for ProcessedBufferSpinLock failed %!STATUS!", (unsigned int)v2);
    goto LABEL_5;
  }
  v8 = (*(__int64 (__fastcall **)(__int64, __int64, void *, _QWORD))(qword_14000A118 + 616))(
         qword_14000A110,  //Status_v8=WdfDeviceCreateDeviceInterface( 创建接口供上层使用
         v15,  //Device_v15
         &unk_140009130,//&GUID_DEVINTERFACE_AmtPtpDeviceSpiKm, //
         0i64);//NULL // ReferenceString 
     
  v2 = v8;//Status_v2=Status_v8
  if ( v8 < 0 )
  {
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 2u, 0x11u, (__int64)&unk_140009140, v8);//NTSTATUS WppTraceCallback(....
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("WdfDeviceCreateDeviceInterface failed %!STATUS!", (unsigned int)v2);
    goto LABEL_5;
  }
  LOBYTE(v10) = 1;//BOOLEAN IsInterfaceEnabled_v10=TRUE;
  (*(void (__fastcall **)(__int64, __int64, void *, _QWORD, int))(qword_14000A118 + 624))(
    qword_14000A110,//void WdfDeviceSetDeviceInterfaceState(
    v15,//Device_v15
    &unk_140009130,//&GUID_DEVINTERFACE_AmtPtpDeviceSpiKm
    0i64,////NULL // ReferenceString 
    v10);//IsInterfaceEnabled_v10
LABEL_20:
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 2u, 0x12u, (__int64)&unk_140009140);NTSTATUS WppTraceCallback(....
    DbgPrint("[PTP] %s : ", "PTPFilterCreateDevice");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
  return (unsigned int)v2;//return Status_v2
}
// 14000D4E7: variable 'v10' is possibly undefined
// 14000A018: using guessed type void *off_14000A018;
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000D558) ----------------------------------------------------
__int64 __fastcall sub_14000D558(__int64 a1, __int64 a2)//NTSTATUS PTPFilterEvtDeviceAdd((IN WDFDRIVER Driver_a1, IN PWDFDEVICE_INIT DeviceInit_a2)
{
  unsigned int v3; // ebx

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 3u, 0xDu, (__int64)&unk_140009150);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtDeviceAdd");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v3 = sub_14000D000(a2);//status_v3 = PTPFilterCreateDevice(DeviceInit_a2);
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 3u, 0xEu, (__int64)&unk_140009150);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtDeviceAdd");
    DbgPrint("%!FUNC! Exit");
    DbgPrint("\n");
  }
  return v3;
}

//----- (000000014000D62C) ----------------------------------------------------
void __fastcall sub_14000D62C(__int64 a1)//EvtDriverContextCleanup(IN WDFDRIVER Driver_a1)
{
  __int64 v2; // rax

  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 3u, 0xFu, (__int64)&unk_140009150);
    DbgPrint("[PTP] %s : ", "PTPFilterEvtDriverContextCleanup");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  v2 = (*(__int64 (__fastcall **)(__int64, __int64))(qword_14000A118 + 944))(qword_14000A110, a1);//DriverObject_v2 =    WdfDriverWdmGetDriverObject( Driver_a1 )
  sub_14000D6B4(v2);//StopWppLog(DriverObject_v2)
}
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

//----- (000000014000D6B4) ----------------------------------------------------
void __fastcall sub_14000D6B4(__int64 a1)//StopWppLog(DriverObject_a1)
{
  PDEVICE_OBJECT v1; // rbx

  v1 = DeviceObject;
  if ( DeviceObject != (PDEVICE_OBJECT)&DeviceObject )
  {
    if ( dword_14000A0E8 == 4 )
    {
      if ( DeviceObject )
      {
        do
        {
          if ( v1->Vpb )//DEVICE_OBJECT_v1->Vpb
            qword_14000A0D0();
          v1 = v1->NextDevice;
        }
        while ( v1 );
        goto LABEL_10;
      }
    }
    else if ( dword_14000A0E8 == 2 )
    {
      IoWMIRegistrationControl(DeviceObject, 0x80000002);//ULONG Action=0x80000002 
      //PROTECTED_DACL_SECURITY_INFORMATION   0x80000000 和GROUP_SECURITY_INFORMATION  0x00000002组合值
LABEL_10:
      v1 = DeviceObject;
      goto LABEL_11;
    }
LABEL_11:
    WppAutoLogStop(v1, a1);//DriverObject_a1
    DeviceObject = (PDEVICE_OBJECT)&DeviceObject;
  }
}
// 140005E48: using guessed type __int64 __fastcall WppAutoLogStop(_QWORD, _QWORD);
// 14000A0D0: using guessed type __int64 (*qword_14000A0D0)(void);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000D740) ----------------------------------------------------
void __fastcall sub_14000D740(__int64 a1, __int64 a2)//StartWPPLog(DriverObject_a1, RegistryPath_a2)
{
  struct _DEVICE_OBJECT *v2; // rbx
  _DRIVER_OBJECT *v5; // rcx

  v2 = &stru_14000A340;//DEVICE_OBJECT_v2=DeviceObject_stru_14000A340;
  if ( DeviceObject != &stru_14000A340 )//DeviceObject_stru_14000A340
  {
    DeviceObject = &stru_14000A340;//DeviceObject = DeviceObject_stru_14000A340
    if ( dword_14000A0E8 == 4 )
    {
      do
      {
        v5 = v2->DriverObject;//pDRIVER_OBJECT_v5=DEVICE_OBJECT_v2->DriverObject;
        v2->Vpb = 0i64;//DEVICE_OBJECT_v2->Vpb = NULL;//Volume Parameter Block (VPB)//调试跟踪用途，不是必需
        qword_14000A0D8(v5, 0i64, sub_14000183C, v2, &v2->Vpb);//(pDRIVER_OBJECT_v5,NULL, sub_14000183C, DeviceObject_stru_14000A340,&DEVICE_OBJECT_v2->Vpb);
        //NTSTATUS NTKERNELAPI EtwRegisterClassicProvider ( LPCGUID ProviderId,  ULONG Type,  PETW_CLASSIC_CALLBACK EnableCallback, PVOID CallbackContext, REGHANDLE *RegHandle);
        v2 = v2->NextDevice;//DEVICE_OBJECT_v2=DEVICE_OBJECT_v2->NextDevice;
      }
      while ( v2 );//DEVICE_OBJECT_v2
    }
    else if ( dword_14000A0E8 == 2 )
    {
      *(_QWORD *)&stru_14000A340.Type = sub_14000D8E0;//DeviceObject_stru_14000A340.Type
      IoWMIRegistrationControl(&stru_14000A340, 0x80010001);//DeviceObject_stru_14000A340
      //PROTECTED_DACL_SECURITY_INFORMATION   0x80000000 和BACKUP_SECURITY_INFORMATION  0x00010000L 及 OWNER_SECURITY_INFORMATION  0x00000001组合值
    }
    WppAutoLogStart(DeviceObject, a1, a2);//WppAutoLogStart(DeviceObject, DriverObject_a1, RegistryPath_a2)
  }
}
// 14000A0D8: invalid function type has been ignored
// 140005E42: using guessed type __int64 __fastcall WppAutoLogStart(_QWORD, _QWORD, _QWORD);
// 14000A0D8: using guessed type __int64 (__fastcall *qword_14000A0D8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000D7E8) ----------------------------------------------------
__int64 (*sub_14000D7E8())(void)//ptpfilter_MmGetSystemRoutine()
{
  __int64 (*result)(void); // rax
  _UNICODE_STRING DestinationString; // [rsp+20h] [rbp-10h] BYREF
  unsigned int v2; // [rsp+40h] [rbp+10h] BYREF

  v2 = 0;
  RtlInitUnicodeString(&DestinationString, L"PsGetVersion");
  qword_14000A0E0 = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD))MmGetSystemRoutineAddress(&DestinationString);
  RtlInitUnicodeString(&DestinationString, L"WmiTraceMessage");
  qword_14000A0C8 = (__int64 (__fastcall *)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD))MmGetSystemRoutineAddress(&DestinationString);
  RtlInitUnicodeString(&DestinationString, L"WmiQueryTraceInformation");
  qword_14000A0C0 = (__int64)MmGetSystemRoutineAddress(&DestinationString);
  result = (__int64 (*)(void))qword_14000A0E0;
  dword_14000A0E8 = 2;
  if ( qword_14000A0E0 )
    result = (__int64 (*)(void))qword_14000A0E0(&v2, 0i64, 0i64, 0i64);
  if ( v2 >= 6 )
  {
    RtlInitUnicodeString(&DestinationString, L"EtwRegisterClassicProvider");//获取WPP跟踪函数作用，
    result = (__int64 (*)(void))MmGetSystemRoutineAddress(&DestinationString);//pfnEtwRegisterClassicProvider_result=
    qword_14000A0D8 = (__int64)result;//qword_14000A0D8=EtwRegisterClassicProvider（。。。）
    if ( result )
    {
      RtlInitUnicodeString(&DestinationString, L"EtwUnregister");
      result = (__int64 (*)(void))MmGetSystemRoutineAddress(&DestinationString);
      qword_14000A0D0 = result;//qword_14000A0D0=NTSTATUS EtwUnregister(REGHANDLE RegHandle);
      dword_14000A0E8 = 4;
    }
  }
  return result;
}
// 14000A0C0: using guessed type __int64 qword_14000A0C0;
// 14000A0C8: using guessed type __int64 (__fastcall *qword_14000A0C8)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0D0: using guessed type __int64 (*qword_14000A0D0)(void);
// 14000A0D8: using guessed type __int64 qword_14000A0D8;
// 14000A0E0: using guessed type __int64 (__fastcall *qword_14000A0E0)(_QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000D8E0) ----------------------------------------------------
__int64 __fastcall sub_14000D8E0(unsigned __int8 a1, __int64 a2, unsigned int a3, unsigned int *a4, __int64 a5, unsigned int *a6)
//sub_14000D8E0=DeviceObject_stru_14000A340.Type
{
  unsigned int *v6; // r13
  unsigned int v7; // ebx
  __int64 v10; // rbp
  unsigned int v11; // edi
  __int64 v12; // rax
  const void **v13; // r12
  unsigned int v14; // er15
  unsigned int v15; // esi
  _WORD *v16; // rcx
  _DWORD *v17; // r14
  __int64 v18; // rcx
  __int128 v19; // xmm0
  __int64 v20; // rdi
  __int64 v21; // rax
  char v23; // [rsp+70h] [rbp+8h] BYREF

  v6 = a6;
  v7 = 0;
  *a6 = 0;
  if ( a1 <= 3u )
    return (unsigned int)-1073741808;//STATUS_INVALID_DEVICE_REQUEST    ((NTSTATUS)0xC0000010L)
  if ( a1 > 5u )
  {
    if ( a1 <= 7u )
      return v7;
    if ( a1 == 8 )
    {
      v10 = a5;//
      v11 = 0;
      v12 = a5;// 
      v13 = *(const void ***)(a5 + 32);// 
      do
      {
        v12 = *(_QWORD *)(v12 + 16);// 
        ++v11;
      }
      while ( v12 );
      if ( v11 > 0x3F )
        return (unsigned int)-1073741811;  // STATUS_INVALID_PARAMETER         ((NTSTATUS)0xC000000DL)
      if ( v13 )
      {
        v14 = 32 * v11 + 24;
        v15 = v14 + *(unsigned __int16 *)v13 + 2;
      }
      else
      {
        v14 = 0;
        v15 = 32 * v11 + 24;
      }
      if ( v15 > a3 )
      {
        v7 = -1073741789;
        if ( a3 >= 4 )
        {
          *a4 = v15;
          *v6 = 4;
        }
      }
      else
      {
        memset(a4, 0, a3);
        *a4 = v15;
        a4[2] = v14;
        a4[4] = v11;
        if ( v13 )
        {
          v16 = (_WORD *)((char *)a4 + v14);
          *v16 = *(_WORD *)v13;
          memmove(v16 + 1, v13[1], *(unsigned __int16 *)v13);
        }
        if ( v11 )
        {
          v17 = a4 + 10;
          v18 = v11;
          do
          {
            v19 = *(_OWORD *)*(_QWORD *)(v10 + 8); //LIST_ENTRY_v10
            *v17 = 528384;
            v17 += 8;
            *((_OWORD *)v17 - 3) = v19;
            *(_BYTE *)(v10 + 41) = 0;
            *(_DWORD *)(v10 + 44) = 0;
            v10 = *(_QWORD *)(v10 + 16);//LIST_ENTRY_v10
            --v18;
          }
          while ( v18 );
        }
        *v6 = v15;
      }
      return v7;
    }
    return (unsigned int)-1073741808;//STATUS_INVALID_DEVICE_REQUEST    ((NTSTATUS)0xC0000010L)
  }
  v20 = a5;
  if ( !a5 )
    return (unsigned int)-1073741163;//STATUS_WMI_GUID_NOT_FOUND        ((NTSTATUS)0xC0000295L)
  if ( a3 < 0x30 )
    return (unsigned int)-1073741811;  // STATUS_INVALID_PARAMETER         ((NTSTATUS)0xC000000DL)
  do
  {
    if ( RtlCompareMemory(*(const void **)(v20 + 8), a4 + 6, 0x10ui64) == 16 ) 
      break;
    v20 = *(_QWORD *)(v20 + 16);//LIST_ENTRY_v20
  }
  while ( v20 );
  if ( !v20 )
    return (unsigned int)-1073741163;//STATUS_WMI_GUID_NOT_FOUND        ((NTSTATUS)0xC0000295L)
  if ( a1 == 5 )
  {
    *(_BYTE *)(v20 + 41) = 0;
    *(_DWORD *)(v20 + 44) = 0;
    *(_QWORD *)(v20 + 24) = 0i64;
  }
  else
  {
    v21 = *((_QWORD *)a4 + 1);
    *(_QWORD *)(v20 + 24) = v21;
    if ( dword_14000A0E8 == 2 )
    {
      if ( !(unsigned int)qword_14000A0C0(3i64, &v23, 4i64, &a6, a4) )
        *(_BYTE *)(v20 + 41) = v23;
      v7 = qword_14000A0C0(2i64, v20 + 44, 4i64, &a6, a4);
    }
    else
    {
      *(_DWORD *)(v20 + 44) = HIDWORD(v21);
      *(_BYTE *)(v20 + 41) = BYTE2(v21);
    }
  }
  return v7;
}
// 14000A0C0: invalid function type has been ignored
// 14000A0C0: using guessed type __int64 (__fastcall *qword_14000A0C0)(_QWORD, _QWORD, _QWORD, _QWORD, _QWORD);
// 14000A0E8: using guessed type int dword_14000A0E8;

//----- (000000014000E000) ----------------------------------------------------
__int64 __fastcall sub_14000E000(__int64 a1, __int64 a2)//FxDriverEntryWorker(DriverObject, RegistryPath)
{
  int v4; // eax
  unsigned int v5; // ebx
  __int64 v7; // [rsp+28h] [rbp-70h]
  __int64 v8[4]; // [rsp+30h] [rbp-68h] BYREF  //WDF_DRIVER_CONFIG      config_v8;
  __int64 Dst[8]; // [rsp+50h] [rbp-48h] BYREF//WDF_OBJECT_ATTRIBUTES  attributes_Dst;

//
  stru_14000A340.Timer = (PIO_TIMER)1;//DeviceObject_stru_14000A340
  *(_QWORD *)&stru_14000A340.Type = 0i64;
  stru_14000A340.DriverObject = (_DRIVER_OBJECT *)&unk_140009110;
  stru_14000A340.NextDevice = 0i64;
  stru_14000A340.CurrentIrp = 0i64;
  stru_14000A340.DeviceExtension = 0i64;
  stru_14000A340.DeviceType = 0;
  sub_14000D7E8();//ptpfilter_MmGetSystemRoutine()  ，没什么实际作用
  stru_14000A340.CurrentIrp = 0i64;////DeviceObject_stru_14000A340.CurrentIrp=NULL;
  sub_14000D740(a1, a2);//StartWPPLog(DriverObject_a1, RegistryPath_a2)
  if ( LOWORD(DeviceObject->DeviceType) )
  {
    sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 3u, 0xAu, (__int64)&unk_140009150);
    DbgPrint("[PTP] %s : ", "DriverEntry");
    DbgPrint("%!FUNC! Entry");
    DbgPrint("\n");
  }
  //以上代码系统自动生成不需要加入
  
  
  //下面3行实际是WDF_OBJECT_ATTRIBUTES_INIT(&attributes_Dst)执行的联合效果;
  memset(Dst, 0, 0x38ui64);//memset(WDF_OBJECT_ATTRIBUTES attributes_Dst,value_0,size_length)
  LODWORD(Dst[0]) = 56;//attributes_Dst.size=0x38??
  Dst[3] = 0x100000001i64;//attributes_Dst.  ??      =-1;
  
  Dst[1] = (__int64)sub_14000D62C;//attributes_Dst.EvtCleanupCallback=EvtDriverContextCleanup
  
  //下面3行实际是WDF_DRIVER_CONFIG_INIT(&config_v8, PTPFilterEvtDeviceAdd)执行的联合效果;
  memset(v8, 0, sizeof(v8));//
  v8[1] = (__int64)sub_14000D558;//config_v8.EvtDriverDeviceAdd=PTPFilterEvtDeviceAdd_sub_14000D558;
  LODWORD(v8[0]) = 32;//config_v8.size=0x20//Config->Size = sizeof(WDF_DRIVER_CONFIG);
  
  v4 = (*(__int64 (__fastcall **)(__int64, __int64, __int64, __int64 *, __int64 *, _QWORD))(qword_14000A118 + 928))(
         qword_14000A110,//status_v4 = WdfDriverCreate(
         a1,//DriverObject_a1
         a2,//	RegistryPath_a2,
         Dst,//	&attributes_Dst,      // Driver Attributes
         v8,//	&config,          // Driver Config Info
         0i64);//	WDF_NO_HANDLE
	);
		
  v5 = v4;
  if ( v4 >= 0 )
  {
    if ( LOWORD(DeviceObject->DeviceType) )
    {
      sub_140001294((__int64)DeviceObject->DeviceExtension, 5u, 3u, 0xCu, (__int64)&unk_140009150);
      DbgPrint("[PTP] %s : ", "DriverEntry");
      DbgPrint("%!FUNC! Exit");
      DbgPrint("\n");
    }
  }
  else
  {
    LODWORD(v7) = v4;
    sub_140002DD4((__int64)DeviceObject->DeviceExtension, 2u, 3u, 0xBu, (__int64)&unk_140009150, v7);
    DbgPrint("[PTP] %s : ", "DriverEntry");
    DbgPrint("WdfDriverCreate failed %!STATUS!", v5);
    DbgPrint("\n");
    sub_14000D6B4(a1);//StopWppLog(DriverObject_a1);
  }
  return v5;
}
// 14000E173: variable 'v7' is possibly undefined
// 14000A110: using guessed type __int64 qword_14000A110;
// 14000A118: using guessed type __int64 qword_14000A118;

// nfuncs=115 queued=87 decompiled=87 lumina nreq=0 worse=0 better=0
// ALL OK, 87 function(s) have been successfully decompiled
